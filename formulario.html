<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio IAT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #2c7a47;
            --secondary-color: #38a169;
            --accent-color: #3182ce;
            --light-color: #f7fafc;
            --dark-color: #2d3748;
        }
        
        body {
            background: linear-gradient(135deg, #f5f9ff 0%, #e6f2ff 100%);
            color: var(--dark-color);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .form-header {
            background: white;
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-info h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        .form-info .form-letter {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .progress-container {
            flex: 1;
            max-width: 400px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #718096;
        }
        
        /* Navigation */
        .form-navigation {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .nav-btn:hover {
            border-color: var(--primary-color);
            background: #f0fff4;
        }
        
        .nav-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Form Sections */
        .form-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Fixed Text Areas */
        .fixed-text {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            font-style: italic;
            color: #4a5568;
            line-height: 1.6;
        }
        
        .fixed-text label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--primary-color);
            font-style: normal;
        }
        
        .fixed-text textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
            font-family: inherit;
        }
        
        /* Questions */
        .question-group {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .question-group:last-child {
            border-bottom: none;
        }
        
        .question-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .required::after {
            content: " *";
            color: #e53e3e;
        }
        
        .question-number {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .answer-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .option-label {
            flex: 1;
            min-width: 150px;
        }
        
        .option-label input[type="radio"] {
            display: none;
        }
        
        .option-label span {
            display: block;
            padding: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-label input[type="radio"]:checked + span {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .option-label:hover span {
            border-color: var(--primary-color);
        }
        
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44,122,71,0.1);
        }
        
        /* Image Upload */
        .image-upload-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-upload-item {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .image-upload-item:hover {
            border-color: var(--primary-color);
            background: #f0fff4;
        }
        
        .image-upload-item i {
            font-size: 2.5rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 160px;
            border-radius: 5px;
            display: none;
        }
        
        .image-upload-item.has-image .image-preview {
            display: block;
        }
        
        .image-upload-item.has-image i {
            display: none;
        }
        
        .image-upload-item input[type="file"] {
            display: none;
        }
        
        .image-caption {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }
        
        .image-upload-item.has-image .image-caption {
            display: block;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            display: none;
        }
        
        .image-upload-item.has-image .remove-image {
            display: flex;
        }
        
        /* Control Buttons */
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(44,122,71,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44,122,71,0.4);
        }
        
        .btn-secondary {
            background: #4a5568;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2d3748;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 24px;
            border-radius: 10px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-navigation {
                flex-wrap: wrap;
            }
            
            .nav-btn {
                min-width: calc(50% - 10px);
            }
            
            .image-upload-area {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .image-upload-item {
                height: 150px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="form-header">
            <div class="form-info">
                <h1><span class="form-letter" id="formLetter">A</span> <span id="formTitle">Formul√°rio A</span></h1>
                <p id="formDescription">Descri√ß√£o do formul√°rio</p>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span>Progresso</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="form-navigation">
            <button class="nav-btn active" onclick="mostrarSecao('perguntas')">
                <i class="fas fa-question-circle"></i> Perguntas
            </button>
            <button class="nav-btn" onclick="mostrarSecao('imagens')">
                <i class="fas fa-images"></i> Imagens (0/15)
            </button>
            <button class="nav-btn" onclick="mostrarSecao('revisao')">
                <i class="fas fa-eye"></i> Revis√£o
            </button>
        </div>
        
        <!-- Se√ß√£o de Perguntas -->
        <div class="form-section active" id="secaoPerguntas">
            <h2 class="section-title"><i class="fas fa-question-circle"></i> Perguntas do Formul√°rio</h2>
            
            <!-- Texto fixo antes das perguntas -->
            <div class="fixed-text">
                <label for="textoAntesPerguntas">Texto fixo antes das perguntas:</label>
                <textarea id="textoAntesPerguntas" placeholder="Digite o texto que aparecer√° antes de todas as perguntas...">Este formul√°rio tem como objetivo coletar dados ambientais para an√°lise t√©cnica. Responda todas as quest√µes com aten√ß√£o aos detalhes. As informa√ß√µes coletadas ser√£o utilizadas para elabora√ß√£o de relat√≥rios t√©cnicos e tomada de decis√µes.</textarea>
            </div>
            
            <!-- Container das perguntas -->
            <div id="perguntasContainer"></div>
            
            <!-- Texto fixo depois das perguntas -->
            <div class="fixed-text">
                <label for="textoDepoisPerguntas">Texto fixo depois das perguntas:</label>
                <textarea id="textoDepoisPerguntas" placeholder="Digite o texto que aparecer√° depois de todas as perguntas...">Agradecemos pelo preenchimento cuidadoso deste formul√°rio. As informa√ß√µes fornecidas s√£o essenciais para nossa an√°lise ambiental. Em caso de d√∫vidas, entre em contato com a equipe t√©cnica.</textarea>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="window.location.href = 'index.html'">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button class="btn btn-primary" onclick="salvarRespostas()">
                    <i class="fas fa-save"></i> Salvar Progresso
                </button>
                <button class="btn btn-primary" onclick="mostrarSecao('imagens')">
                    Pr√≥ximo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Se√ß√£o de Imagens -->
        <div class="form-section" id="secaoImagens">
            <h2 class="section-title"><i class="fas fa-images"></i> Upload de Imagens</h2>
            
            <!-- Texto fixo antes das imagens -->
            <div class="fixed-text">
                <label for="textoAntesImagens">Texto fixo antes das imagens:</label>
                <textarea id="textoAntesImagens" placeholder="Digite o texto que aparecer√° antes das imagens...">Adicione at√© 15 imagens relacionadas √† pesquisa. Certifique-se de que as imagens sejam n√≠tidas e representativas das condi√ß√µes observadas. Cada imagem deve ter uma legenda descritiva.</textarea>
            </div>
            
            <!-- Container de upload de imagens -->
            <div class="image-upload-area" id="imageUploadContainer"></div>
            
            <!-- Texto fixo depois das imagens -->
            <div class="fixed-text">
                <label for="textoDepoisImagens">Texto fixo depois das imagens:</label>
                <textarea id="textoDepoisImagens" placeholder="Digite o texto que aparecer√° depois das imagens...">As imagens foram documentadas e associadas aos dados coletados. Elas servir√£o como evid√™ncia visual para complementar a an√°lise t√©cnica.</textarea>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="mostrarSecao('perguntas')">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" onclick="salvarImagens()">
                    <i class="fas fa-save"></i> Salvar Imagens
                </button>
                <button class="btn btn-primary" onclick="mostrarSecao('revisao')">
                    Pr√≥ximo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Se√ß√£o de Revis√£o -->
        <div class="form-section" id="secaoRevisao">
            <h2 class="section-title"><i class="fas fa-eye"></i> Revis√£o Final</h2>
            
            <div class="fixed-text">
                <label for="textoFinal">Texto final antes de gerar PDF:</label>
                <textarea id="textoFinal" placeholder="Digite o texto final que aparecer√° antes de gerar o PDF...">Todos os dados foram revisados e est√£o prontos para gera√ß√£o do relat√≥rio. Certifique-se de que todas as informa√ß√µes est√£o corretas antes de prosseguir.</textarea>
            </div>
            
            <!-- Resumo das respostas -->
            <div id="resumoRespostas" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Resumo das Respostas</h3>
                <div id="resumoContent"></div>
            </div>
            
            <!-- Resumo das imagens -->
            <div id="resumoImagens" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Imagens Adicionadas (<span id="contadorImagens">0</span>/15)</h3>
                <div id="resumoImagensContent"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="mostrarSecao('imagens')">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-success" onclick="gerarPDF()">
                    <i class="fas fa-file-pdf"></i> Gerar PDF
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // Dados do formul√°rio atual
        let formularioAtual = 'A';
        let dadosFormulario = {
            respostas: {},
            imagens: [],
            textosFixos: {
                antesPerguntas: '',
                depoisPerguntas: '',
                antesImagens: '',
                depoisImagens: '',
                textoFinal: ''
            }
        };
        
        // Perguntas padr√£o para cada formul√°rio (30 perguntas)
        const perguntasPorFormulario = {
            A: [
                "Qual a temperatura da √°gua (¬∞C)?",
                "Qual o pH da √°gua?",
                "Qual a turbidez da √°gua (NTU)?",
                "Qual a condutividade el√©trica (¬µS/cm)?",
                "Qual a concentra√ß√£o de oxig√™nio dissolvido (mg/L)?",
                "Qual a cor da √°gua?",
                "Existe presen√ßa de odor na √°gua?",
                "Qual a transpar√™ncia da √°gua (disco de Secchi)?",
                "Existe presen√ßa de espumas na superf√≠cie?",
                "Qual a velocidade da corrente (m/s)?",
                "Existe presen√ßa de sedimentos em suspens√£o?",
                "Qual a profundidade m√©dia (m)?",
                "Existe presen√ßa de algas vis√≠veis?",
                "Qual a cor do sedimento do fundo?",
                "Existe presen√ßa de res√≠duos s√≥lidos?",
                "Qual o tipo de res√≠duo predominante?",
                "Existe lan√ßamento de efluentes vis√≠vel?",
                "Qual a dist√¢ncia da fonte poluidora mais pr√≥xima?",
                "Existe vegeta√ß√£o aqu√°tica presente?",
                "Qual o tipo de vegeta√ß√£o predominante?",
                "Existe atividade pesqueira no local?",
                "Existe atividade de recrea√ß√£o no local?",
                "Qual o uso do solo no entorno?",
                "Existe presen√ßa de animais dom√©sticos?",
                "Existe presen√ßa de animais silvestres?",
                "Qual a condi√ß√£o da mata ciliar?",
                "Existe eros√£o nas margens?",
                "Qual o tipo de eros√£o predominante?",
                "Existe obras civis no entorno?",
                "Qual o estado de conserva√ß√£o geral do local?"
            ],
            B: [
                "Qual a largura da faixa de vegeta√ß√£o rip√°ria?",
                "Qual a altura m√©dia das √°rvores?",
                "Qual a diversidade de esp√©cies arb√≥reas?",
                "Existe presen√ßa de esp√©cies ex√≥ticas?",
                "Qual o grau de cobertura do dossel?",
                "Existe presen√ßa de sub-bosque?",
                "Qual a densidade de vegeta√ß√£o herb√°cea?",
                "Existe presen√ßa de bambuzais?",
                "Qual o estado de conserva√ß√£o da vegeta√ß√£o?",
                "Existe evid√™ncia de desmatamento?",
                "Qual a idade estimada da vegeta√ß√£o?",
                "Existe presen√ßa de ep√≠fitas?",
                "Qual a quantidade de serapilheira?",
                "Existe presen√ßa de trepadeiras?",
                "Qual o tipo de solo predominante?",
                "Existe presen√ßa de afloramentos rochosos?",
                "Qual a inclina√ß√£o do terreno?",
                "Existe presen√ßa de nascentes na √°rea?",
                "Qual a dist√¢ncia do corpo h√≠drico principal?",
                "Existe presen√ßa de animais na vegeta√ß√£o?",
                "Qual o tipo de fauna observada?",
                "Existe presen√ßa de ninhos?",
                "Qual a ocorr√™ncia de flora√ß√£o?",
                "Existe presen√ßa de frutos?",
                "Qual a √©poca do ano predominante?",
                "Existe influ√™ncia antr√≥pica na vegeta√ß√£o?",
                "Qual o tipo de impacto antr√≥pico?",
                "Existe medidas de recupera√ß√£o em curso?",
                "Qual a necessidade de interven√ß√£o?",
                "Qual o potencial de regenera√ß√£o natural?"
            ]
            // Adicionar mais formul√°rios C, D, E, F...
        };
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Obter formul√°rio selecionado da URL
            const urlParams = new URLSearchParams(window.location.search);
            formularioAtual = urlParams.get('form') || 'A';
            
            // Configurar informa√ß√µes do formul√°rio
            configurarFormulario();
            
            // Carregar dados salvos
            carregarDados();
            
            // Gerar perguntas
            gerarPerguntas();
            
            // Gerar upload de imagens
            gerarUploadImagens();
            
            // Atualizar progresso
            atualizarProgresso();
            
            // Configurar navega√ß√£o
            configurarNavegacao();
        });
        
        function configurarFormulario() {
            const formularios = {
                A: { titulo: "Formul√°rio A - Qualidade da √Ågua", descricao: "Avalia√ß√£o de par√¢metros f√≠sicos, qu√≠micos e biol√≥gicos da √°gua", cor: "#2c7a47" },
                B: { titulo: "Formul√°rio B - Vegeta√ß√£o Rip√°ria", descricao: "Caracteriza√ß√£o da vegeta√ß√£o √†s margens de corpos h√≠dricos", cor: "#38a169" },
                C: { titulo: "Formul√°rio C - Geologia e Solos", descricao: "An√°lise de caracter√≠sticas geol√≥gicas e tipos de solo", cor: "#d69e2e" },
                D: { titulo: "Formul√°rio D - Fauna Aqu√°tica", descricao: "Invent√°rio e monitoramento de esp√©cies aqu√°ticas", cor: "#3182ce" },
                E: { titulo: "Formul√°rio E - Impactos Antr√≥picos", descricao: "Avalia√ß√£o de impactos humanos no ambiente", cor: "#e53e3e" },
                F: { titulo: "Formul√°rio F - Monitoramento Clim√°tico", descricao: "Registro de dados clim√°ticos e meteorol√≥gicos", cor: "#805ad5" }
            };
            
            const form = formularios[formularioAtual] || formularios.A;
            
            document.getElementById('formLetter').textContent = formularioAtual;
            document.getElementById('formLetter').style.background = form.cor;
            document.getElementById('formTitle').textContent = form.titulo;
            document.getElementById('formDescription').textContent = form.descricao;
            
            // Definir cor prim√°ria
            document.documentElement.style.setProperty('--primary-color', form.cor);
        }
        
        function gerarPerguntas() {
            const container = document.getElementById('perguntasContainer');
            const perguntas = perguntasPorFormulario[formularioAtual] || perguntasPorFormulario.A;
            
            let html = '';
            
            perguntas.forEach((pergunta, index) => {
                const perguntaNum = index + 1;
                const perguntaId = `pergunta_${perguntaNum}`;
                
                html += `
                    <div class="question-group">
                        <label class="question-label">
                            <span class="question-number">${perguntaNum}</span>
                            ${pergunta} <span class="required">*</span>
                        </label>
                        
                        <div class="answer-options">
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="Excelente" required>
                                <span>Excelente</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="Bom" required>
                                <span>Bom</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="Regular" required>
                                <span>Regular</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="Ruim" required>
                                <span>Ruim</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="P√©ssimo" required>
                                <span>P√©ssimo</span>
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label for="${perguntaId}_obs" style="display: block; margin-bottom: 8px; color: #4a5568;">
                                <i class="fas fa-comment"></i> Observa√ß√µes (opcional):
                            </label>
                            <textarea id="${perguntaId}_obs" 
                                      placeholder="Adicione observa√ß√µes sobre esta resposta..."
                                      rows="2"></textarea>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Preencher com dados salvos
            if (dadosFormulario.respostas) {
                Object.keys(dadosFormulario.respostas).forEach(perguntaId => {
                    const resposta = dadosFormulario.respostas[perguntaId];
                    const radio = document.querySelector(`input[name="${perguntaId}"][value="${resposta.resposta}"]`);
                    if (radio) radio.checked = true;
                    
                    const obs = document.getElementById(`${perguntaId}_obs`);
                    if (obs && resposta.observacoes) obs.value = resposta.observacoes;
                });
            }
            
            // Preencher textos fixos
            if (dadosFormulario.textosFixos) {
                document.getElementById('textoAntesPerguntas').value = dadosFormulario.textosFixos.antesPerguntas || '';
                document.getElementById('textoDepoisPerguntas').value = dadosFormulario.textosFixos.depoisPerguntas || '';
                document.getElementById('textoAntesImagens').value = dadosFormulario.textosFixos.antesImagens || '';
                document.getElementById('textoDepoisImagens').value = dadosFormulario.textosFixos.depoisImagens || '';
                document.getElementById('textoFinal').value = dadosFormulario.textosFixos.textoFinal || '';
            }
        }
        
        function gerarUploadImagens() {
            const container = document.getElementById('imageUploadContainer');
            let html = '';
            
            for (let i = 1; i <= 15; i++) {
                html += `
                    <div class="image-upload-item" id="imageItem_${i}" onclick="document.getElementById('fileInput_${i}').click()">
                        <i class="fas fa-camera"></i>
                        <p style="font-size: 0.9rem; color: #718096;">Imagem ${i}</p>
                        <img class="image-preview" id="preview_${i}" alt="Pr√©-visualiza√ß√£o">
                        <input type="file" id="fileInput_${i}" accept="image/*" onchange="previewImage(${i}, this)">
                        <input type="text" class="image-caption" id="caption_${i}" placeholder="Legenda da imagem..." oninput="salvarLegenda(${i}, this.value)">
                        <div class="remove-image" onclick="removerImagem(${i}, event)">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Carregar imagens salvas
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                dadosFormulario.imagens.forEach(img => {
                    if (img.data && img.index) {
                        const item = document.getElementById(`imageItem_${img.index}`);
                        const preview = document.getElementById(`preview_${img.index}`);
                        const caption = document.getElementById(`caption_${img.index}`);
                        
                        if (item && preview && caption) {
                            preview.src = img.data;
                            preview.style.display = 'block';
                            caption.value = img.legenda || '';
                            item.classList.add('has-image');
                        }
                    }
                });
                atualizarContadorImagens();
            }
        }
        
        function previewImage(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validar tamanho (10MB m√°ximo)
            if (file.size > 10 * 1024 * 1024) {
                mostrarToast('A imagem deve ter no m√°ximo 10MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.getElementById(`imageItem_${index}`);
                const preview = document.getElementById(`preview_${index}`);
                const caption = document.getElementById(`caption_${index}`);
                
                preview.src = e.target.result;
                preview.style.display = 'block';
                item.classList.add('has-image');
                
                // Salvar imagem
                if (!dadosFormulario.imagens) dadosFormulario.imagens = [];
                
                const imagemIndex = dadosFormulario.imagens.findIndex(img => img.index === index);
                if (imagemIndex !== -1) {
                    dadosFormulario.imagens[imagemIndex] = {
                        index: index,
                        data: e.target.result,
                        legenda: caption.value,
                        nome: file.name,
                        tipo: file.type,
                        tamanho: file.size
                    };
                } else {
                    dadosFormulario.imagens.push({
                        index: index,
                        data: e.target.result,
                        legenda: caption.value,
                        nome: file.name,
                        tipo: file.type,
                        tamanho: file.size
                    });
                }
                
                atualizarContadorImagens();
                mostrarToast(`Imagem ${index} carregada com sucesso`, 'success');
            };
            
            reader.readAsDataURL(file);
        }
        
        function salvarLegenda(index, legenda) {
            if (dadosFormulario.imagens) {
                const imagemIndex = dadosFormulario.imagens.findIndex(img => img.index === index);
                if (imagemIndex !== -1) {
                    dadosFormulario.imagens[imagemIndex].legenda = legenda;
                }
            }
        }
        
        function removerImagem(index, event) {
            event.stopPropagation();
            
            const item = document.getElementById(`imageItem_${index}`);
            const preview = document.getElementById(`preview_${index}`);
            const caption = document.getElementById(`caption_${index}`);
            const fileInput = document.getElementById(`fileInput_${index}`);
            
            item.classList.remove('has-image');
            preview.style.display = 'none';
            preview.src = '';
            caption.value = '';
            fileInput.value = '';
            
            // Remover dos dados
            if (dadosFormulario.imagens) {
                dadosFormulario.imagens = dadosFormulario.imagens.filter(img => img.index !== index);
            }
            
            atualizarContadorImagens();
            mostrarToast(`Imagem ${index} removida`, 'warning');
        }
        
        function atualizarContadorImagens() {
            const count = dadosFormulario.imagens ? dadosFormulario.imagens.length : 0;
            document.querySelector('.nav-btn:nth-child(2)').innerHTML = 
                `<i class="fas fa-images"></i> Imagens (${count}/15)`;
            document.getElementById('contadorImagens').textContent = count;
        }
        
        function mostrarSecao(secao) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.form-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Atualizar navega√ß√£o
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(`secao${secao.charAt(0).toUpperCase() + secao.slice(1)}`).classList.add('active');
            
            // Atualizar bot√£o ativo
            const btnIndex = { perguntas: 0, imagens: 1, revisao: 2 }[secao];
            document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            
            // Se for revis√£o, atualizar resumo
            if (secao === 'revisao') {
                atualizarResumo();
            }
            
            // Atualizar progresso
            atualizarProgresso();
        }
        
        function configurarNavegacao() {
            const botoes = document.querySelectorAll('.nav-btn');
            botoes.forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    botoes.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }
        
        function salvarRespostas() {
            // Coletar textos fixos
            dadosFormulario.textosFixos = {
                antesPerguntas: document.getElementById('textoAntesPerguntas').value,
                depoisPerguntas: document.getElementById('textoDepoisPerguntas').value,
                antesImagens: document.getElementById('textoAntesImagens').value,
                depoisImagens: document.getElementById('textoDepoisImagens').value,
                textoFinal: document.getElementById('textoFinal').value
            };
            
            // Coletar respostas
            const perguntas = perguntasPorFormulario[formularioAtual] || perguntasPorFormulario.A;
            perguntas.forEach((_, index) => {
                const perguntaNum = index + 1;
                const perguntaId = `pergunta_${perguntaNum}`;
                
                const resposta = document.querySelector(`input[name="${perguntaId}"]:checked`);
                const observacoes = document.getElementById(`${perguntaId}_obs`).value;
                
                if (resposta) {
                    dadosFormulario.respostas[perguntaId] = {
                        resposta: resposta.value,
                        observacoes: observacoes,
                        pergunta: perguntas[index]
                    };
                }
            });
            
            // Salvar no localStorage
            localStorage.setItem(`formulario_${formularioAtual}`, JSON.stringify(dadosFormulario));
            
            mostrarToast('Progresso salvo com sucesso! ‚úÖ', 'success');
            atualizarProgresso();
        }
        
        function salvarImagens() {
            salvarRespostas(); // Salva tamb√©m as respostas
            
            // J√° estamos salvando imagens em tempo real
            mostrarToast('Imagens salvas com sucesso! ‚úÖ', 'success');
        }
        
        function carregarDados() {
            const dadosSalvos = localStorage.getItem(`formulario_${formularioAtual}`);
            if (dadosSalvos) {
                try {
                    dadosFormulario = JSON.parse(dadosSalvos);
                    mostrarToast('Dados anteriores carregados', 'info');
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                }
            }
        }
        
        function atualizarProgresso() {
            let progresso = 0;
            const totalPerguntas = 30;
            const totalImagens = 15;
            
            // Progresso das perguntas
            if (dadosFormulario.respostas) {
                const respostasPreenchidas = Object.keys(dadosFormulario.respostas).length;
                progresso += (respostasPreenchidas / totalPerguntas) * 50;
            }
            
            // Progresso das imagens
            if (dadosFormulario.imagens) {
                progresso += (dadosFormulario.imagens.length / totalImagens) * 50;
            }
            
            progresso = Math.min(100, Math.round(progresso));
            
            document.getElementById('progressFill').style.width = `${progresso}%`;
            document.getElementById('progressPercent').textContent = `${progresso}%`;
        }
        
        function atualizarResumo() {
            const resumoContent = document.getElementById('resumoContent');
            let html = '';
            
            // Resumo das respostas
            if (dadosFormulario.respostas && Object.keys(dadosFormulario.respostas).length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #4a5568; margin-bottom: 15px;">Perguntas Respondidas:</h4>';
                
                Object.entries(dadosFormulario.respostas).forEach(([perguntaId, dados], index) => {
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                            <strong>${index + 1}. ${dados.pergunta}</strong><br>
                            <span style="color: var(--primary-color);">Resposta: ${dados.resposta}</span>
                            ${dados.observacoes ? `<br><em>Observa√ß√µes: ${dados.observacoes}</em>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<p style="color: #718096;">Nenhuma pergunta respondida ainda.</p>';
            }
            
            resumoContent.innerHTML = html;
            
            // Resumo das imagens
            const resumoImagens = document.getElementById('resumoImagensContent');
            let htmlImagens = '';
            
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                htmlImagens += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">';
                
                dadosFormulario.imagens.forEach(img => {
                    htmlImagens += `
                        <div style="text-align: center;">
                            <img src="${img.data}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 5px; margin-bottom: 5px;">
                            <div style="font-size: 0.8rem; color: #4a5568;">${img.legenda || 'Sem legenda'}</div>
                        </div>
                    `;
                });
                
                htmlImagens += '</div>';
            } else {
                htmlImagens = '<p style="color: #718096;">Nenhuma imagem adicionada.</p>';
            }
            
            resumoImagens.innerHTML = htmlImagens;
        }
        
        function gerarPDF() {
            if (!confirm('Gerar relat√≥rio PDF com todos os dados?')) return;
            
            mostrarToast('Gerando PDF... ‚è≥', 'info');
            
            // Simular gera√ß√£o de PDF
            setTimeout(() => {
                const nomeArquivo = `Formulario_${formularioAtual}_${new Date().toISOString().slice(0,10)}.pdf`;
                
                // Criar conte√∫do do PDF simulado
                let conteudoPDF = `
                    RELAT√ìRIO FORMUL√ÅRIO ${formularioAtual}
                    =====================================
                    
                    Data: ${new Date().toLocaleDateString()}
                    
                    ${dadosFormulario.textosFixos.antesPerguntas || ''}
                    
                    PERGUNTAS E RESPOSTAS:
                    ----------------------
                `;
                
                // Adicionar perguntas e respostas
                Object.entries(dadosFormulario.respostas).forEach(([perguntaId, dados], index) => {
                    conteudoPDF += `
                    ${index + 1}. ${dados.pergunta}
                       Resposta: ${dados.resposta}
                       ${dados.observacoes ? `Observa√ß√µes: ${dados.observacoes}` : ''}
                    `;
                });
                
                conteudoPDF += `
                    
                    ${dadosFormulario.textosFixos.depoisPerguntas || ''}
                    
                    ${dadosFormulario.textosFixos.antesImagens || ''}
                    
                    IMAGENS:
                    --------
                    Total: ${dadosFormulario.imagens ? dadosFormulario.imagens.length : 0} imagens
                `;
                
                // Adicionar informa√ß√µes das imagens
                if (dadosFormulario.imagens) {
                    dadosFormulario.imagens.forEach(img => {
                        conteudoPDF += `
                    Imagem ${img.index}: ${img.legenda || 'Sem legenda'}
                        Nome: ${img.nome}
                        Tamanho: ${(img.tamanho / 1024).toFixed(2)} KB
                        `;
                    });
                }
                
                conteudoPDF += `
                    
                    ${dadosFormulario.textosFixos.depoisImagens || ''}
                    
                    ${dadosFormulario.textosFixos.textoFinal || ''}
                    
                    =====================================
                    Relat√≥rio gerado automaticamente pelo Sistema IAT
                `;
                
                // Criar e baixar arquivo
                const blob = new Blob([conteudoPDF], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nomeArquivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                mostrarToast(`PDF "${nomeArquivo}" gerado com sucesso! üìÑ`, 'success');
            }, 2000);
        }
        
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${icons[tipo] || 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            
            toast.className = `toast show`;
            toast.style.background = {
                success: '#2c7a47',
                error: '#e53e3e',
                warning: '#d69e2e',
                info: '#3182ce'
            }[tipo] || '#2c7a47';
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Salvar automaticamente ao sair
        window.addEventListener('beforeunload', function() {
            if (Object.keys(dadosFormulario.respostas).length > 0 || 
                (dadosFormulario.imagens && dadosFormulario.imagens.length > 0)) {
                salvarRespostas();
            }
        });
    </script>
</body>
</html>
