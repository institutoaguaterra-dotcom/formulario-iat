<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário IAT</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #2c7a47;
            --secondary-color: #38a169;
            --accent-color: #3182ce;
            --light-color: #f7fafc;
            --dark-color: #2d3748;
        }
        
        body {
            background: linear-gradient(135deg, #f5f9ff 0%, #e6f2ff 100%);
            color: var(--dark-color);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header */
        .form-header {
            background: white;
            border-radius: 15px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .form-info h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        .form-info .form-letter {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .progress-container {
            flex: 1;
            max-width: 400px;
        }
        
        .progress-bar {
            height: 10px;
            background: #e2e8f0;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #718096;
        }
        
        /* Navigation */
        .form-navigation {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .nav-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .nav-btn:hover {
            border-color: var(--primary-color);
            background: #f0fff4;
        }
        
        .nav-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        /* Form Sections */
        .form-section {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section.active {
            display: block;
        }
        
        .section-title {
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Fixed Text Areas - SOMENTE LEITURA */
        .fixed-text {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            line-height: 1.6;
            font-size: 0.95rem;
            color: #4a5568;
        }
        
        .fixed-text-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 10px;
            display: block;
            font-size: 1rem;
        }
        
        /* Questions */
        .question-group {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .question-group:last-child {
            border-bottom: none;
        }
        
        .question-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 1.1rem;
        }
        
        .required::after {
            content: " *";
            color: #e53e3e;
        }
        
        .question-number {
            display: inline-block;
            background: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            font-size: 0.9rem;
            margin-right: 10px;
        }
        
        .answer-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        .option-label {
            flex: 1;
            min-width: 150px;
        }
        
        .option-label input[type="radio"] {
            display: none;
        }
        
        .option-label span {
            display: block;
            padding: 15px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .option-label input[type="radio"]:checked + span {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .option-label:hover span {
            border-color: var(--primary-color);
        }
        
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(44,122,71,0.1);
        }
        
        /* Image Upload */
        .image-upload-area {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-upload-item {
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f7fafc;
            height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .image-upload-item:hover {
            border-color: var(--primary-color);
            background: #f0fff4;
        }
        
        .image-upload-item i {
            font-size: 2.5rem;
            color: #a0aec0;
            margin-bottom: 15px;
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 160px;
            border-radius: 5px;
            display: none;
        }
        
        .image-upload-item.has-image .image-preview {
            display: block;
        }
        
        .image-upload-item.has-image i {
            display: none;
        }
        
        .image-upload-item input[type="file"] {
            display: none;
        }
        
        .image-caption {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }
        
        .image-upload-item.has-image .image-caption {
            display: block;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            display: none;
        }
        
        .image-upload-item.has-image .remove-image {
            display: flex;
        }
        
        /* Control Buttons */
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-width: 150px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            box-shadow: 0 4px 15px rgba(44,122,71,0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(44,122,71,0.4);
        }
        
        .btn-secondary {
            background: #4a5568;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2d3748;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 24px;
            border-radius: 10px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 300px;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .form-navigation {
                flex-wrap: wrap;
            }
            
            .nav-btn {
                min-width: calc(50% - 10px);
            }
            
            .image-upload-area {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .image-upload-item {
                height: 150px;
            }
            
            .control-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="form-header">
            <div class="form-info">
                <h1><span class="form-letter" id="formLetter">A</span> <span id="formTitle">Formulário A</span></h1>
                <p id="formDescription">Descrição do formulário</p>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span>Progresso</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="form-navigation">
            <button class="nav-btn active" onclick="mostrarSecao('perguntas')">
                <i class="fas fa-question-circle"></i> Perguntas
            </button>
            <button class="nav-btn" onclick="mostrarSecao('imagens')">
                <i class="fas fa-images"></i> Imagens (0/15)
            </button>
            <button class="nav-btn" onclick="mostrarSecao('revisao')">
                <i class="fas fa-eye"></i> Revisão
            </button>
        </div>
        
        <!-- Seção de Perguntas -->
        <div class="form-section active" id="secaoPerguntas">
            <h2 class="section-title"><i class="fas fa-question-circle"></i> Perguntas do Formulário</h2>
            
            <!-- Texto fixo ANTES das perguntas (EDITÁVEL NO CÓDIGO) -->
            <div class="fixed-text">
                <span class="fixed-text-title">TEXTO INTRODUTÓRIO:</span>
                <div id="textoAntesPerguntas"></div>
            </div>
            
            <!-- Container das perguntas -->
            <div id="perguntasContainer"></div>
            
            <!-- Texto fixo DEPOIS das perguntas (EDITÁVEL NO CÓDIGO) -->
            <div class="fixed-text">
                <span class="fixed-text-title">TEXTO DE ENCERRAMENTO:</span>
                <div id="textoDepoisPerguntas"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="window.location.href = 'index.html'">
                    <i class="fas fa-arrow-left"></i> Voltar
                </button>
                <button class="btn btn-primary" onclick="salvarRespostas()">
                    <i class="fas fa-save"></i> Salvar Progresso
                </button>
                <button class="btn btn-primary" onclick="mostrarSecao('imagens')">
                    Próximo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Seção de Imagens -->
        <div class="form-section" id="secaoImagens">
            <h2 class="section-title"><i class="fas fa-images"></i> Upload de Imagens</h2>
            
            <!-- Texto fixo ANTES das imagens (EDITÁVEL NO CÓDIGO) -->
            <div class="fixed-text">
                <span class="fixed-text-title">INSTRUÇÕES PARA FOTOS:</span>
                <div id="textoAntesImagens"></div>
            </div>
            
            <!-- Container de upload de imagens -->
            <div class="image-upload-area" id="imageUploadContainer"></div>
            
            <!-- Texto fixo DEPOIS das imagens (EDITÁVEL NO CÓDIGO) -->
            <div class="fixed-text">
                <span class="fixed-text-title">OBSERVAÇÕES FINAIS:</span>
                <div id="textoDepoisImagens"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="mostrarSecao('perguntas')">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-primary" onclick="salvarImagens()">
                    <i class="fas fa-save"></i> Salvar Imagens
                </button>
                <button class="btn btn-primary" onclick="mostrarSecao('revisao')">
                    Próximo <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Seção de Revisão -->
        <div class="form-section" id="secaoRevisao">
            <h2 class="section-title"><i class="fas fa-eye"></i> Revisão Final</h2>
            
            <!-- Texto final (EDITÁVEL NO CÓDIGO) -->
            <div class="fixed-text">
                <span class="fixed-text-title">CONSIDERAÇÕES FINAIS:</span>
                <div id="textoFinal"></div>
            </div>
            
            <!-- Resumo das respostas -->
            <div id="resumoRespostas" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Resumo das Respostas</h3>
                <div id="resumoContent"></div>
            </div>
            
            <!-- Resumo das imagens -->
            <div id="resumoImagens" style="margin: 30px 0; padding: 20px; background: #f7fafc; border-radius: 10px;">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;">Imagens Adicionadas (<span id="contadorImagens">0</span>/15)</h3>
                <div id="resumoImagensContent"></div>
            </div>
            
            <div class="control-buttons">
                <button class="btn btn-secondary" onclick="mostrarSecao('imagens')">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="btn btn-success" onclick="gerarPDFABNT()">
                    <i class="fas fa-file-pdf"></i> Gerar PDF ABNT
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // TEXTO FIXO PRÉ-DEFINIDO - EDITAR AQUI
        // ============================================
        const TEXTOS_FIXOS = {
            antesPerguntas: `
                <p>Este formulário foi elaborado pelo Instituto Água e Terra (IAT) com o objetivo de padronizar a coleta de dados ambientais em campo. As informações coletadas serão utilizadas para:</p>
                <ul>
                    <li>Monitoramento da qualidade ambiental</li>
                    <li>Elaboração de relatórios técnicos</li>
                    <li>Suporte à tomada de decisões</li>
                    <li>Atendimento à legislação ambiental</li>
                </ul>
                <p><strong>Instruções:</strong> Responda todas as questões com atenção, baseando-se nas observações de campo. Utilize a escala de 1 a 5 para avaliar cada aspecto, onde 1 representa condição inadequada e 5 condição ideal.</p>
            `,
            
            depoisPerguntas: `
                <p>O preenchimento deste formulário deve ser realizado por profissional habilitado, preferencialmente com formação na área ambiental. Todas as respostas devem refletir a realidade observada em campo, sem inferências ou suposições.</p>
                <p><strong>Importante:</strong> As informações aqui registradas possuem valor legal e podem ser utilizadas em processos administrativos e judiciais. Certifique-se da veracidade dos dados informados.</p>
                <p>A próxima etapa consiste no registro fotográfico das condições observadas.</p>
            `,
            
            antesImagens: `
                <p>Esta seção destina-se ao registro fotográfico das condições observadas em campo. São permitidas até 15 imagens, que devem:</p>
                <ul>
                    <li>Ser nítidas e bem iluminadas</li>
                    <li>Representar fielmente as condições observadas</li>
                    <li>Incluir legenda descritiva</li>
                    <li>Ter data e hora do registro (automática)</li>
                </ul>
                <p><strong>Orientações técnicas:</strong></p>
                <ol>
                    <li>Incluir sempre uma foto do panorama geral do local</li>
                    <li>Registrar detalhes específicos mencionados nas respostas</li>
                    <li>Incluir fotos com escala (pessoa, objeto de referência)</li>
                    <li>Evitar fotos com pessoas identificáveis</li>
                </ol>
            `,
            
            depoisImagens: `
                <p>O registro fotográfico complementa e valida as informações textuais coletadas. As imagens servem como:</p>
                <ul>
                    <li>Evidência documental das condições observadas</li>
                    <li>Material de apoio para análises técnicas</li>
                    <li>Base para comparações temporais</li>
                    <li>Elemento ilustrativo em relatórios</li>
                </ul>
                <p><strong>Atenção:</strong> As imagens serão armazenadas junto com os demais dados e poderão ser recuperadas para consulta ou produção de relatórios. Certifique-se de que todas as fotos estão adequadamente legendadas.</p>
            `,
            
            textoFinal: `
                <p>Este relatório foi gerado automaticamente pelo Sistema de Coleta de Dados do Instituto Água e Terra. Todos os dados foram coletados seguindo protocolos técnicos estabelecidos pela instituição.</p>
                <p><strong>Validade:</strong> Os dados apresentados refletem as condições observadas na data da coleta. Recomenda-se a realização de monitoramentos periódicos para acompanhamento das variações temporais.</p>
                <p><strong>Responsabilidade técnica:</strong> O profissional que coletou os dados é responsável pela veracidade das informações registradas.</p>
                <p>Ao gerar o relatório em formato PDF, você estará criando um documento oficial com formatação ABNT, incluindo cabeçalho e rodapé padronizados.</p>
            `
        };
        
        // URLs das imagens do cabeçalho e rodapé (substitua pelos seus URLs)
        const IMAGENS_PDF = {
            cabecalho: './imagens/cabecalho.png',
            rodape: './imagens/rodape.png'
        };
        
        // Dados do formulário atual
        let formularioAtual = 'A';
        let dadosFormulario = {
            respostas: {},
            imagens: [],
            informacoesColeta: {
                data: new Date().toLocaleDateString('pt-BR'),
                hora: new Date().toLocaleTimeString('pt-BR'),
                pesquisador: '',
                matricula: ''
            }
        };
        
        // Perguntas padrão para cada formulário (30 perguntas)
        const perguntasPorFormulario = {
            A: [
                "Qual a temperatura da água (°C)?",
                "Qual o pH da água?",
                "Qual a turbidez da água (NTU)?",
                "Qual a condutividade elétrica (µS/cm)?",
                "Qual a concentração de oxigênio dissolvido (mg/L)?",
                "Qual a cor da água?",
                "Existe presença de odor na água?",
                "Qual a transparência da água (disco de Secchi)?",
                "Existe presença de espumas na superfície?",
                "Qual a velocidade da corrente (m/s)?",
                "Existe presença de sedimentos em suspensão?",
                "Qual a profundidade média (m)?",
                "Existe presença de algas visíveis?",
                "Qual a cor do sedimento do fundo?",
                "Existe presença de resíduos sólidos?",
                "Qual o tipo de resíduo predominante?",
                "Existe lançamento de efluentes visível?",
                "Qual a distância da fonte poluidora mais próxima?",
                "Existe vegetação aquática presente?",
                "Qual o tipo de vegetação predominante?",
                "Existe atividade pesqueira no local?",
                "Existe atividade de recreação no local?",
                "Qual o uso do solo no entorno?",
                "Existe presença de animais domésticos?",
                "Existe presença de animais silvestres?",
                "Qual a condição da mata ciliar?",
                "Existe erosão nas margens?",
                "Qual o tipo de erosão predominante?",
                "Existe obras civis no entorno?",
                "Qual o estado de conservação geral do local?"
            ],
            B: [
                "Qual a largura da faixa de vegetação ripária?",
                "Qual a altura média das árvores?",
                "Qual a diversidade de espécies arbóreas?",
                "Existe presença de espécies exóticas?",
                "Qual o grau de cobertura do dossel?",
                "Existe presença de sub-bosque?",
                "Qual a densidade de vegetação herbácea?",
                "Existe presença de bambuzais?",
                "Qual o estado de conservação da vegetação?",
                "Existe evidência de desmatamento?",
                "Qual a idade estimada da vegetação?",
                "Existe presença de epífitas?",
                "Qual a quantidade de serapilheira?",
                "Existe presença de trepadeiras?",
                "Qual o tipo de solo predominante?",
                "Existe presença de afloramentos rochosos?",
                "Qual a inclinação do terreno?",
                "Existe presença de nascentes na área?",
                "Qual a distância do corpo hídrico principal?",
                "Existe presença de animais na vegetação?",
                "Qual o tipo de fauna observada?",
                "Existe presença de ninhos?",
                "Qual a ocorrência de floração?",
                "Existe presença de frutos?",
                "Qual a época do ano predominante?",
                "Existe influência antrópica na vegetação?",
                "Qual o tipo de impacto antrópico?",
                "Existe medidas de recuperação em curso?",
                "Qual a necessidade de intervenção?",
                "Qual o potencial de regeneração natural?"
            ]
            // Adicionar C, D, E, F conforme necessário
        };
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Obter formulário selecionado da URL
            const urlParams = new URLSearchParams(window.location.search);
            formularioAtual = urlParams.get('form') || 'A';
            
            // Configurar informações do formulário
            configurarFormulario();
            
            // Inserir textos fixos (pré-definidos no código)
            inserirTextosFixos();
            
            // Carregar dados salvos
            carregarDados();
            
            // Gerar perguntas
            gerarPerguntas();
            
            // Gerar upload de imagens
            gerarUploadImagens();
            
            // Atualizar progresso
            atualizarProgresso();
            
            // Configurar navegação
            configurarNavegacao();
        });
        
        function configurarFormulario() {
            const formularios = {
                A: { titulo: "Formulário A - Qualidade da Água", descricao: "Avaliação de parâmetros físicos, químicos e biológicos da água", cor: "#2c7a47" },
                B: { titulo: "Formulário B - Vegetação Ripária", descricao: "Caracterização da vegetação às margens de corpos hídricos", cor: "#38a169" },
                C: { titulo: "Formulário C - Geologia e Solos", descricao: "Análise de características geológicas e tipos de solo", cor: "#d69e2e" },
                D: { titulo: "Formulário D - Fauna Aquática", descricao: "Inventário e monitoramento de espécies aquáticas", cor: "#3182ce" },
                E: { titulo: "Formulário E - Impactos Antrópicos", descricao: "Avaliação de impactos humanos no ambiente", cor: "#e53e3e" },
                F: { titulo: "Formulário F - Monitoramento Climático", descricao: "Registro de dados climáticos e meteorológicos", cor: "#805ad5" }
            };
            
            const form = formularios[formularioAtual] || formularios.A;
            
            document.getElementById('formLetter').textContent = formularioAtual;
            document.getElementById('formLetter').style.background = form.cor;
            document.getElementById('formTitle').textContent = form.titulo;
            document.getElementById('formDescription').textContent = form.descricao;
            
            // Definir cor primária
            document.documentElement.style.setProperty('--primary-color', form.cor);
        }
        
        function inserirTextosFixos() {
            // Inserir textos pré-definidos (NÃO editáveis pelo usuário)
            document.getElementById('textoAntesPerguntas').innerHTML = TEXTOS_FIXOS.antesPerguntas;
            document.getElementById('textoDepoisPerguntas').innerHTML = TEXTOS_FIXOS.depoisPerguntas;
            document.getElementById('textoAntesImagens').innerHTML = TEXTOS_FIXOS.antesImagens;
            document.getElementById('textoDepoisImagens').innerHTML = TEXTOS_FIXOS.depoisImagens;
            document.getElementById('textoFinal').innerHTML = TEXTOS_FIXOS.textoFinal;
        }
        
        function gerarPerguntas() {
            const container = document.getElementById('perguntasContainer');
            const perguntas = perguntasPorFormulario[formularioAtual] || perguntasPorFormulario.A;
            
            let html = '';
            
            perguntas.forEach((pergunta, index) => {
                const perguntaNum = index + 1;
                const perguntaId = `pergunta_${perguntaNum}`;
                
                html += `
                    <div class="question-group">
                        <label class="question-label">
                            <span class="question-number">${perguntaNum}</span>
                            ${pergunta} <span class="required">*</span>
                        </label>
                        
                        <div class="answer-options">
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="1 - Insatisfatório" required>
                                <span>1 - Insatisfatório</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="2 - Regular" required>
                                <span>2 - Regular</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="3 - Bom" required>
                                <span>3 - Bom</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="4 - Muito Bom" required>
                                <span>4 - Muito Bom</span>
                            </label>
                            <label class="option-label">
                                <input type="radio" name="${perguntaId}" value="5 - Excelente" required>
                                <span>5 - Excelente</span>
                            </label>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <label for="${perguntaId}_obs" style="display: block; margin-bottom: 8px; color: #4a5568;">
                                <i class="fas fa-comment"></i> Observações (opcional):
                            </label>
                            <textarea id="${perguntaId}_obs" 
                                      placeholder="Adicione observações detalhadas sobre esta resposta..."
                                      rows="3"></textarea>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Preencher com dados salvos
            if (dadosFormulario.respostas) {
                Object.keys(dadosFormulario.respostas).forEach(perguntaId => {
                    const resposta = dadosFormulario.respostas[perguntaId];
                    const radio = document.querySelector(`input[name="${perguntaId}"][value="${resposta.resposta}"]`);
                    if (radio) radio.checked = true;
                    
                    const obs = document.getElementById(`${perguntaId}_obs`);
                    if (obs && resposta.observacoes) obs.value = resposta.observacoes;
                });
            }
        }
        
        function gerarUploadImagens() {
            const container = document.getElementById('imageUploadContainer');
            let html = '';
            
            for (let i = 1; i <= 15; i++) {
                html += `
                    <div class="image-upload-item" id="imageItem_${i}" onclick="document.getElementById('fileInput_${i}').click()">
                        <i class="fas fa-camera"></i>
                        <p style="font-size: 0.9rem; color: #718096;">Imagem ${i}</p>
                        <img class="image-preview" id="preview_${i}" alt="Pré-visualização">
                        <input type="file" id="fileInput_${i}" accept="image/*" onchange="previewImage(${i}, this)">
                        <input type="text" class="image-caption" id="caption_${i}" placeholder="Digite a legenda da imagem..." oninput="salvarLegenda(${i}, this.value)">
                        <div class="remove-image" onclick="removerImagem(${i}, event)">
                            <i class="fas fa-times"></i>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
            
            // Carregar imagens salvas
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                dadosFormulario.imagens.forEach(img => {
                    if (img.data && img.index) {
                        const item = document.getElementById(`imageItem_${img.index}`);
                        const preview = document.getElementById(`preview_${img.index}`);
                        const caption = document.getElementById(`caption_${img.index}`);
                        
                        if (item && preview && caption) {
                            preview.src = img.data;
                            preview.style.display = 'block';
                            caption.value = img.legenda || '';
                            item.classList.add('has-image');
                        }
                    }
                });
                atualizarContadorImagens();
            }
        }
        
        function previewImage(index, input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validar tamanho (5MB máximo)
            if (file.size > 5 * 1024 * 1024) {
                mostrarToast('A imagem deve ter no máximo 5MB', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const item = document.getElementById(`imageItem_${index}`);
                const preview = document.getElementById(`preview_${index}`);
                const caption = document.getElementById(`caption_${index}`);
                
                preview.src = e.target.result;
                preview.style.display = 'block';
                item.classList.add('has-image');
                
                // Salvar imagem
                if (!dadosFormulario.imagens) dadosFormulario.imagens = [];
                
                const imagemIndex = dadosFormulario.imagens.findIndex(img => img.index === index);
                if (imagemIndex !== -1) {
                    dadosFormulario.imagens[imagemIndex] = {
                        index: index,
                        data: e.target.result,
                        legenda: caption.value,
                        nome: file.name,
                        tipo: file.type,
                        tamanho: file.size,
                        dataUpload: new Date().toISOString()
                    };
                } else {
                    dadosFormulario.imagens.push({
                        index: index,
                        data: e.target.result,
                        legenda: caption.value,
                        nome: file.name,
                        tipo: file.type,
                        tamanho: file.size,
                        dataUpload: new Date().toISOString()
                    });
                }
                
                atualizarContadorImagens();
                mostrarToast(`Imagem ${index} carregada com sucesso`, 'success');
            };
            
            reader.readAsDataURL(file);
        }
        
        function salvarLegenda(index, legenda) {
            if (dadosFormulario.imagens) {
                const imagemIndex = dadosFormulario.imagens.findIndex(img => img.index === index);
                if (imagemIndex !== -1) {
                    dadosFormulario.imagens[imagemIndex].legenda = legenda;
                }
            }
        }
        
        function removerImagem(index, event) {
            event.stopPropagation();
            
            const item = document.getElementById(`imageItem_${index}`);
            const preview = document.getElementById(`preview_${index}`);
            const caption = document.getElementById(`caption_${index}`);
            const fileInput = document.getElementById(`fileInput_${index}`);
            
            item.classList.remove('has-image');
            preview.style.display = 'none';
            preview.src = '';
            caption.value = '';
            fileInput.value = '';
            
            // Remover dos dados
            if (dadosFormulario.imagens) {
                dadosFormulario.imagens = dadosFormulario.imagens.filter(img => img.index !== index);
            }
            
            atualizarContadorImagens();
            mostrarToast(`Imagem ${index} removida`, 'warning');
        }
        
        function atualizarContadorImagens() {
            const count = dadosFormulario.imagens ? dadosFormulario.imagens.length : 0;
            document.querySelector('.nav-btn:nth-child(2)').innerHTML = 
                `<i class="fas fa-images"></i> Imagens (${count}/15)`;
            document.getElementById('contadorImagens').textContent = count;
        }
        
        function mostrarSecao(secao) {
            // Esconder todas as seções
            document.querySelectorAll('.form-section').forEach(sec => {
                sec.classList.remove('active');
            });
            
            // Atualizar navegação
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar seção selecionada
            document.getElementById(`secao${secao.charAt(0).toUpperCase() + secao.slice(1)}`).classList.add('active');
            
            // Atualizar botão ativo
            const btnIndex = { perguntas: 0, imagens: 1, revisao: 2 }[secao];
            document.querySelectorAll('.nav-btn')[btnIndex].classList.add('active');
            
            // Se for revisão, atualizar resumo
            if (secao === 'revisao') {
                atualizarResumo();
            }
            
            // Atualizar progresso
            atualizarProgresso();
        }
        
        function configurarNavegacao() {
            const botoes = document.querySelectorAll('.nav-btn');
            botoes.forEach((btn, index) => {
                btn.addEventListener('click', () => {
                    botoes.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }
        
        function salvarRespostas() {
            // Coletar informações do pesquisador (pode ser um modal no futuro)
            if (!dadosFormulario.informacoesColeta.pesquisador) {
                dadosFormulario.informacoesColeta.pesquisador = prompt("Digite seu nome completo:");
                dadosFormulario.informacoesColeta.matricula = prompt("Digite sua matrícula:");
            }
            
            // Coletar respostas
            const perguntas = perguntasPorFormulario[formularioAtual] || perguntasPorFormulario.A;
            let todasRespondidas = true;
            
            perguntas.forEach((pergunta, index) => {
                const perguntaNum = index + 1;
                const perguntaId = `pergunta_${perguntaNum}`;
                
                const resposta = document.querySelector(`input[name="${perguntaId}"]:checked`);
                const observacoes = document.getElementById(`${perguntaId}_obs`).value;
                
                if (resposta) {
                    dadosFormulario.respostas[perguntaId] = {
                        numero: perguntaNum,
                        pergunta: pergunta,
                        resposta: resposta.value,
                        observacoes: observacoes
                    };
                } else {
                    todasRespondidas = false;
                }
            });
            
            if (!todasRespondidas) {
                mostrarToast('Responda todas as perguntas antes de salvar', 'error');
                return;
            }
            
            // Salvar no localStorage
            localStorage.setItem(`formulario_${formularioAtual}`, JSON.stringify(dadosFormulario));
            
            mostrarToast('Progresso salvo com sucesso! ✅', 'success');
            atualizarProgresso();
        }
        
        function salvarImagens() {
            salvarRespostas(); // Salva também as respostas
            mostrarToast('Imagens salvas com sucesso! ✅', 'success');
        }
        
        function carregarDados() {
            const dadosSalvos = localStorage.getItem(`formulario_${formularioAtual}`);
            if (dadosSalvos) {
                try {
                    dadosFormulario = JSON.parse(dadosSalvos);
                    mostrarToast('Dados anteriores carregados', 'info');
                } catch (e) {
                    console.error('Erro ao carregar dados:', e);
                }
            }
        }
        
        function atualizarProgresso() {
            let progresso = 0;
            const totalPerguntas = 30;
            const totalImagens = 15;
            
            // Progresso das perguntas
            if (dadosFormulario.respostas) {
                const respostasPreenchidas = Object.keys(dadosFormulario.respostas).length;
                progresso += (respostasPreenchidas / totalPerguntas) * 50;
            }
            
            // Progresso das imagens
            if (dadosFormulario.imagens) {
                progresso += (dadosFormulario.imagens.length / totalImagens) * 50;
            }
            
            progresso = Math.min(100, Math.round(progresso));
            
            document.getElementById('progressFill').style.width = `${progresso}%`;
            document.getElementById('progressPercent').textContent = `${progresso}%`;
        }
        
        function atualizarResumo() {
            const resumoContent = document.getElementById('resumoContent');
            let html = '';
            
            // Resumo das respostas
            if (dadosFormulario.respostas && Object.keys(dadosFormulario.respostas).length > 0) {
                html += '<div style="margin-bottom: 20px;">';
                html += '<h4 style="color: #4a5568; margin-bottom: 15px;">Perguntas Respondidas:</h4>';
                
                Object.values(dadosFormulario.respostas).forEach(dados => {
                    html += `
                        <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 5px; border-left: 4px solid var(--primary-color);">
                            <strong>${dados.numero}. ${dados.pergunta}</strong><br>
                            <span style="color: var(--primary-color);">Resposta: ${dados.resposta}</span>
                            ${dados.observacoes ? `<br><em>Observações: ${dados.observacoes}</em>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<p style="color: #718096;">Nenhuma pergunta respondida ainda.</p>';
            }
            
            resumoContent.innerHTML = html;
            
            // Resumo das imagens
            const resumoImagens = document.getElementById('resumoImagensContent');
            let htmlImagens = '';
            
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                htmlImagens += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">';
                
                dadosFormulario.imagens.forEach(img => {
                    htmlImagens += `
                        <div style="text-align: center;">
                            <img src="${img.data}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 5px; margin-bottom: 5px;">
                            <div style="font-size: 0.8rem; color: #4a5568;">${img.legenda || 'Sem legenda'}</div>
                        </div>
                    `;
                });
                
                htmlImagens += '</div>';
            } else {
                htmlImagens = '<p style="color: #718096;">Nenhuma imagem adicionada.</p>';
            }
            
            resumoImagens.innerHTML = htmlImagens;
        }
        
        // ============================================
        // FUNÇÃO PARA GERAR PDF COM FORMATAÇÃO ABNT
        // ============================================
        function gerarPDFABNT() {
            if (!confirm('Gerar relatório PDF com formatação ABNT?')) return;
            
            mostrarToast('Gerando PDF ABNT... ⏳', 'info');
            
            // Usar jsPDF para gerar PDF mais avançado
            if (typeof pdfLib === 'undefined') {
                // Carregar biblioteca jsPDF
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                script.onload = function() {
                    const script2 = document.createElement('script');
                    script2.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js';
                    script2.onload = gerarPDFComABNT;
                    document.head.appendChild(script2);
                };
                document.head.appendChild(script);
            } else {
                gerarPDFComABNT();
            }
        }
        
        function gerarPDFComABNT() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurações ABNT
            const margemEsquerda = 30;
            const margemDireita = 20;
            const margemSuperior = 40;
            const larguraUtil = 210 - margemEsquerda - margemDireita;
            let yPos = margemSuperior;
            
            // ============================================
            // CABEÇALHO EM CADA PÁGINA
            // ============================================
            const addHeader = () => {
                // Imagem do cabeçalho
                try {
                    // Se tiver imagem do cabeçalho, adicionar
                    doc.addImage(IMAGENS_PDF.cabecalho, 'PNG', margemEsquerda, 10, larguraUtil, 20);
                } catch (e) {
                    // Cabeçalho textual se imagem falhar
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text("INSTITUTO ÁGUA E TERRA - IAT", 105, 20, { align: 'center' });
                    doc.setFontSize(11);
                    doc.setFont('helvetica', 'normal');
                    doc.text("Relatório Técnico de Campo", 105, 27, { align: 'center' });
                    doc.text(`Formulário ${formularioAtual}`, 105, 34, { align: 'center' });
                }
                
                // Linha separadora
                doc.setLineWidth(0.5);
                doc.line(margemEsquerda, 38, 210 - margemDireita, 38);
                yPos = 45;
            };
            
            // ============================================
            // RODAPÉ EM CADA PÁGINA
            // ============================================
            const addFooter = (pageNumber) => {
                const footerY = 287;
                
                // Linha separadora
                doc.setLineWidth(0.5);
                doc.line(margemEsquerda, footerY - 15, 210 - margemDireita, footerY - 15);
                
                // Imagem do rodapé
                try {
                    doc.addImage(IMAGENS_PDF.rodape, 'PNG', margemEsquerda, footerY - 10, larguraUtil, 10);
                } catch (e) {
                    // Rodapé textual se imagem falhar
                    doc.setFontSize(8);
                    doc.setFont('helvetica', 'italic');
                    doc.text("Instituto Água e Terra - Secretaria do Desenvolvimento Sustentável e Turismo", 105, footerY - 5, { align: 'center' });
                }
                
                // Número da página
                doc.setFontSize(9);
                doc.text(`Página ${pageNumber}`, 190, footerY - 5, { align: 'right' });
            };
            
            // ============================================
            // FUNÇÃO PARA ADICIONAR NOVA PÁGINA
            // ============================================
            const addNewPage = () => {
                doc.addPage();
                yPos = margemSuperior;
                addHeader();
            };
            
            // ============================================
            // FUNÇÃO PARA ADICIONAR TÍTULO
            // ============================================
            const addTitle = (text) => {
                if (yPos > 250) addNewPage();
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(text, margemEsquerda, yPos);
                yPos += 10;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(11);
            };
            
            // ============================================
            // FUNÇÃO PARA ADICIONAR TEXTO
            // ============================================
            const addText = (text, isBold = false) => {
                if (yPos > 250) addNewPage();
                
                doc.setFont('helvetica', isBold ? 'bold' : 'normal');
                const lines = doc.splitTextToSize(text, larguraUtil);
                
                lines.forEach(line => {
                    if (yPos > 250) {
                        addNewPage();
                    }
                    doc.text(line, margemEsquerda, yPos);
                    yPos += 7;
                });
                
                doc.setFont('helvetica', 'normal');
            };
            
            // ============================================
            // INICIAR DOCUMENTO
            // ============================================
            addHeader();
            
            // ============================================
            // CAPA
            // ============================================
            addTitle("RELATÓRIO TÉCNICO DE CAMPO");
            yPos += 5;
            
            addText(`Formulário: ${formularioAtual}`, true);
            addText(`Título: ${document.getElementById('formTitle').textContent}`);
            addText(`Data da Coleta: ${dadosFormulario.informacoesColeta.data}`);
            addText(`Hora da Coleta: ${dadosFormulario.informacoesColeta.hora}`);
            addText(`Pesquisador: ${dadosFormulario.informacoesColeta.pesquisador || 'Não informado'}`);
            addText(`Matrícula: ${dadosFormulario.informacoesColeta.matricula || 'Não informada'}`);
            addText(`Data de Geração: ${new Date().toLocaleDateString('pt-BR')}`);
            addText(`Hora de Geração: ${new Date().toLocaleTimeString('pt-BR')}`);
            
            yPos += 15;
            addText("Documento gerado automaticamente pelo Sistema de Coleta de Dados IAT");
            
            // ============================================
            // RESUMO EXECUTIVO
            // ============================================
            addNewPage();
            addTitle("1. RESUMO EXECUTIVO");
            addText("Este relatório apresenta os resultados da coleta de dados de campo realizada pelo Instituto Água e Terra (IAT). As informações foram coletadas seguindo protocolos técnicos estabelecidos e estão organizadas conforme as normas da ABNT.");
            
            // ============================================
            // METODOLOGIA
            // ============================================
            yPos += 10;
            addTitle("2. METODOLOGIA");
            addText("A coleta de dados foi realizada através de formulário padronizado contendo 30 questões específicas para avaliação ambiental. Cada questão foi respondida utilizando escala de 1 a 5, sendo:");
            addText("1 - Insatisfatório: Condição crítica, requer intervenção imediata");
            addText("2 - Regular: Condição abaixo do esperado, necessita melhorias");
            addText("3 - Bom: Condição dentro dos padrões aceitáveis");
            addText("4 - Muito Bom: Condição acima da média");
            addText("5 - Excelente: Condição ideal, modelo a ser seguido");
            addText("Além das respostas quantitativas, foram registradas observações qualitativas para cada item.");
            
            // ============================================
            // INTRODUÇÃO (TEXTO FIXO ANTES)
            // ============================================
            addNewPage();
            addTitle("3. INTRODUÇÃO");
            addText(TEXTOS_FIXOS.antesPerguntas.replace(/<[^>]*>/g, ' '));
            
            // ============================================
            // RESULTADOS DAS PERGUNTAS
            // ============================================
            yPos += 10;
            addTitle("4. RESULTADOS");
            
            if (dadosFormulario.respostas && Object.keys(dadosFormulario.respostas).length > 0) {
                // Tabela de resultados
                const tableData = [];
                Object.values(dadosFormulario.respostas).forEach(resposta => {
                    tableData.push([
                        resposta.numero.toString(),
                        resposta.pergunta,
                        resposta.resposta,
                        resposta.observacoes || '-'
                    ]);
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Nº', 'Pergunta', 'Resposta', 'Observações']],
                    body: tableData,
                    margin: { left: margemEsquerda, right: margemDireita },
                    headStyles: { fillColor: [44, 122, 71] },
                    alternateRowStyles: { fillColor: [240, 255, 244] },
                    styles: { fontSize: 9, cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 10 },
                        1: { cellWidth: 80 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 45 }
                    },
                    didDrawPage: function(data) {
                        // Adicionar cabeçalho e rodapé em cada página da tabela
                        addHeader();
                        addFooter(doc.internal.getNumberOfPages());
                    }
                });
                
                yPos = doc.lastAutoTable.finalY + 10;
            }
            
            // ============================================
            // CONSIDERAÇÕES (TEXTO FIXO DEPOIS)
            // ============================================
            addText("5. CONSIDERAÇÕES");
            addText(TEXTOS_FIXOS.depoisPerguntas.replace(/<[^>]*>/g, ' '));
            
            // ============================================
            // REGISTRO FOTOGRÁFICO
            // ============================================
            addNewPage();
            addTitle("6. REGISTRO FOTOGRÁFICO");
            addText(TEXTOS_FIXOS.antesImagens.replace(/<[^>]*>/g, ' '));
            
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                yPos += 10;
                addText(`Total de imagens registradas: ${dadosFormulario.imagens.length}`);
                
                // Lista de imagens
                dadosFormulario.imagens.forEach((img, index) => {
                    if (yPos > 200) {
                        addNewPage();
                        yPos = margemSuperior;
                    }
                    
                    addText(`Imagem ${index + 1}: ${img.legenda || 'Sem legenda'}`, true);
                    addText(`Arquivo: ${img.nome} | Tamanho: ${(img.tamanho / 1024).toFixed(2)} KB | Data: ${new Date(img.dataUpload).toLocaleDateString('pt-BR')}`);
                    yPos += 5;
                });
            } else {
                addText("Nenhuma imagem foi registrada durante a coleta de dados.");
            }
            
            // ============================================
            // ANÁLISE DAS IMAGENS (TEXTO FIXO DEPOIS)
            // ============================================
            yPos += 10;
            addText("7. ANÁLISE DAS EVIDÊNCIAS VISUAIS");
            addText(TEXTOS_FIXOS.depoisImagens.replace(/<[^>]*>/g, ' '));
            
            // ============================================
            // CONCLUSÕES
            // ============================================
            addNewPage();
            addTitle("8. CONCLUSÕES");
            addText(TEXTOS_FIXOS.textoFinal.replace(/<[^>]*>/g, ' '));
            
            // ============================================
            // REFERÊNCIAS
            // ============================================
            yPos += 10;
            addTitle("9. REFERÊNCIAS");
            addText("ASSOCIAÇÃO BRASILEIRA DE NORMAS TÉCNICAS. NBR 14724: Informação e documentação: Trabalhos acadêmicos: Apresentação. Rio de Janeiro, 2011.");
            addText("INSTITUTO ÁGUA E TERRA. Manual de Procedimentos de Campo. Curitiba, 2023.");
            addText("CONAMA. Resolução nº 357, de 17 de março de 2005. Dispõe sobre a classificação dos corpos de água e diretrizes ambientais para o seu enquadramento.");
            
            // ============================================
            // ANEXOS
            // ============================================
            if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                addNewPage();
                addTitle("ANEXOS: REGISTROS FOTOGRÁFICOS");
                addText("As imagens a seguir foram registradas durante a coleta de dados e compõem as evidências visuais do relatório.");
                
                // Adicionar miniaturas das imagens (quando possível)
                let imgY = yPos;
                let imgX = margemEsquerda;
                let imgCount = 0;
                
                dadosFormulario.imagens.forEach(img => {
                    try {
                        if (imgCount > 0 && imgCount % 2 === 0) {
                            imgY += 60;
                            imgX = margemEsquerda;
                        }
                        
                        if (imgY > 200) {
                            addNewPage();
                            imgY = margemSuperior;
                            imgX = margemEsquerda;
                        }
                        
                        // Adicionar imagem reduzida
                        doc.addImage(img.data, 'JPEG', imgX, imgY, 70, 50);
                        
                        // Legenda
                        doc.setFontSize(8);
                        doc.text(img.legenda.substring(0, 40) + (img.legenda.length > 40 ? '...' : ''), imgX + 35, imgY + 55, { align: 'center' });
                        
                        imgX += 80;
                        imgCount++;
                    } catch (e) {
                        console.log('Erro ao adicionar imagem ao PDF:', e);
                    }
                });
            }
            
            // ============================================
            // ADICIONAR RODAPÉ NA ÚLTIMA PÁGINA
            // ============================================
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                addFooter(i);
            }
            
            // ============================================
            // SALVAR PDF
            // ============================================
            const nomeArquivo = `IAT_Form${formularioAtual}_${dadosFormulario.informacoesColeta.pesquisador.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.pdf`;
            doc.save(nomeArquivo);
            
            mostrarToast(`PDF "${nomeArquivo}" gerado com formatação ABNT! 📄`, 'success');
        }
        
        // ============================================
        // FUNÇÃO DE TOAST
        // ============================================
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `
                <i class="fas fa-${icons[tipo] || 'info-circle'}"></i>
                <span>${mensagem}</span>
            `;
            
            toast.className = `toast show`;
            toast.style.background = {
                success: '#2c7a47',
                error: '#e53e3e',
                warning: '#d69e2e',
                info: '#3182ce'
            }[tipo] || '#2c7a47';
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Salvar automaticamente ao sair
        window.addEventListener('beforeunload', function() {
            if (Object.keys(dadosFormulario.respostas).length > 0 || 
                (dadosFormulario.imagens && dadosFormulario.imagens.length > 0)) {
                salvarRespostas();
            }
        });
    </script>
</body>
</html>
