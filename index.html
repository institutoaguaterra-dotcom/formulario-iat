<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formul√°rio IAT - Pesquisa de Campo Offline</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f5f9ff; color: #333; line-height: 1.6; padding: 20px; }
        
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,100,0,0.1); overflow: hidden; }
        
        header { background: linear-gradient(135deg, #2c7a47, #38a169); color: white; padding: 25px; text-align: center; }
        .logo { font-size: 2.8rem; margin-bottom: 10px; }
        h1 { font-size: 1.8rem; margin-bottom: 10px; }
        
        .status { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; font-size: 0.9rem; }
        
        .main { display: grid; grid-template-columns: 1fr 300px; gap: 20px; padding: 25px; }
        @media (max-width: 768px) { .main { grid-template-columns: 1fr; } }
        
        .form-section { background: #f9f9f9; padding: 20px; border-radius: 10px; }
        .sidebar { background: #f0f7ff; padding: 20px; border-radius: 10px; border-left: 5px solid #2c7a47; }
        
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c7a47; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: #2c7a47; outline: none; box-shadow: 0 0 0 3px rgba(44,122,71,0.2); }
        
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 25px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.3s; font-size: 16px; }
        .btn-primary { background: #2c7a47; color: white; }
        .btn-primary:hover { background: #22543d; }
        .btn-secondary { background: #4a5568; color: white; }
        
        .step { display: none; }
        .step.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .steps { display: flex; justify-content: center; margin: 25px 0; }
        .step-circle { width: 35px; height: 35px; border-radius: 50%; background: #ddd; display: flex; align-items: center; justify-content: center; font-weight: bold; margin: 0 10px; }
        .step-circle.active { background: #2c7a47; color: white; }
        
        .summary { background: white; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .summary-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0; }
        
        .install-btn { background: #3182ce; color: white; width: 100%; margin-top: 15px; }
        
        footer { text-align: center; padding: 20px; background: #f7fafc; color: #718096; font-size: 0.9rem; border-top: 1px solid #e2e8f0; }
        
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; background: #2c7a47; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; z-index: 1000; }
        .toast.show { display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-tint"></i>
            </div>
            <h1>Instituto √Ågua e Terra - IAT</h1>
            <p>Formul√°rio de Pesquisa de Campo - Vers√£o Offline</p>
            <div class="status" id="status">
                <i class="fas fa-wifi"></i> <span>Online</span>
            </div>
        </header>
        
        <div class="main">
            <section class="form-section">
                <div class="steps">
                    <div class="step-circle active">1</div>
                    <div class="step-circle">2</div>
                    <div class="step-circle">3</div>
                    <div class="step-circle">4</div>
                </div>
                
                <form id="iatForm">
                    <!-- Passo 1 -->
                    <div class="step active" id="step1">
                        <h2><i class="fas fa-user"></i> Identifica√ß√£o</h2>
                        <div class="form-group">
                            <label for="nome">Nome do Pesquisador *</label>
                            <input type="text" id="nome" required placeholder="Digite seu nome completo">
                        </div>
                        <div class="form-group">
                            <label for="matricula">Matr√≠cula/Registro *</label>
                            <input type="text" id="matricula" required placeholder="Sua matr√≠cula no IAT">
                        </div>
                        <div class="form-group">
                            <label for="data">Data da Pesquisa *</label>
                            <input type="date" id="data" required>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="nextStep()">
                            Pr√≥ximo <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    
                    <!-- Passo 2 -->
                    <div class="step" id="step2">
                        <h2><i class="fas fa-map-marker-alt"></i> Localiza√ß√£o</h2>
                        <div class="form-group">
                            <label for="municipio">Munic√≠pio *</label>
                            <input type="text" id="municipio" required placeholder="Nome do munic√≠pio">
                        </div>
                        <div class="form-group">
                            <label for="latitude">Latitude *</label>
                            <input type="text" id="latitude" required placeholder="Ex: -25.4284">
                        </div>
                        <div class="form-group">
                            <label for="longitude">Longitude *</label>
                            <input type="text" id="longitude" required placeholder="Ex: -49.2733">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Pr√≥ximo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Passo 3 -->
                    <div class="step" id="step3">
                        <h2><i class="fas fa-water"></i> Caracter√≠sticas</h2>
                        <div class="form-group">
                            <label>Tipo de Corpo H√≠drico *</label><br>
                            <label><input type="radio" name="tipo" value="Rio" required> Rio</label>
                            <label><input type="radio" name="tipo" value="Lago"> Lago</label>
                            <label><input type="radio" name="tipo" value="Nascente"> Nascente</label>
                            <label><input type="radio" name="tipo" value="Reservat√≥rio"> Reservat√≥rio</label>
                        </div>
                        <div class="form-group">
                            <label for="observacoes">Observa√ß√µes</label>
                            <textarea id="observacoes" rows="4" placeholder="Descreva as caracter√≠sticas do local..."></textarea>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Pr√≥ximo <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Passo 4 -->
                    <div class="step" id="step4">
                        <h2><i class="fas fa-file-pdf"></i> Finaliza√ß√£o</h2>
                        <div class="form-group">
                            <label for="assinatura">Assinatura Digital</label>
                            <canvas id="canvas" width="500" height="200" style="border: 2px dashed #ccc; border-radius: 8px; cursor: crosshair;"></canvas>
                            <button type="button" class="btn btn-secondary" onclick="limparAssinatura()" style="margin-top: 10px;">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="termo" required>
                                Confirmo que os dados est√£o corretos *
                            </label>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="prevStep()">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="gerarPDF()">
                                <i class="fas fa-download"></i> Gerar PDF
                            </button>
                        </div>
                    </div>
                </form>
            </section>
            
            <aside class="sidebar">
                <h3><i class="fas fa-list"></i> Resumo</h3>
                <div id="resumo" class="summary">
                    Preencha o formul√°rio para ver o resumo aqui.
                </div>
                
                <h3 style="margin-top: 25px;"><i class="fas fa-tools"></i> A√ß√µes</h3>
                <button class="btn btn-secondary" onclick="salvarLocal()" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-save"></i> Salvar Localmente
                </button>
                <button class="btn btn-secondary" onclick="carregarLocal()" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-folder-open"></i> Carregar Dados
                </button>
                <button class="btn btn-secondary" onclick="limparFormulario()" style="width: 100%;">
                    <i class="fas fa-trash"></i> Limpar Tudo
                </button>
                
                <div style="margin-top: 25px; padding: 15px; background: #e6fffa; border-radius: 8px; text-align: center;">
                    <h4><i class="fas fa-mobile-alt"></i> Instalar no Celular</h4>
                    <p style="font-size: 0.9rem; margin: 10px 0;">Para usar como app:</p>
                    <button class="btn install-btn" onclick="instalarPWA()">
                        <i class="fas fa-download"></i> Instalar App
                    </button>
                    <p style="font-size: 0.8rem; margin-top: 10px; color: #4a5568;">
                        No Chrome Android: Menu ‚Üí "Adicionar √† tela inicial"
                    </p>
                </div>
            </aside>
        </div>
        
        <footer>
            <p>¬© 2023 Instituto √Ågua e Terra (IAT) - Paran√°</p>
            <p>Este aplicativo funciona offline. Dados salvos localmente no dispositivo.</p>
        </footer>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // Configura√ß√£o inicial
        let passoAtual = 1;
        const ctx = document.getElementById('canvas').getContext('2d');
        let desenhando = false;
        let dados = {};
        
        // Data atual como padr√£o
        document.getElementById('data').valueAsDate = new Date();
        
        // Assinatura digital
        document.getElementById('canvas').addEventListener('mousedown', iniciarDesenho);
        document.getElementById('canvas').addEventListener('mousemove', desenhar);
        document.getElementById('canvas').addEventListener('mouseup', pararDesenho);
        
        function iniciarDesenho(e) {
            desenhando = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }
        
        function desenhar(e) {
            if (!desenhando) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
        
        function pararDesenho() {
            desenhando = false;
        }
        
        function limparAssinatura() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        }
        
        // Navega√ß√£o do formul√°rio
        function nextStep() {
            if (passoAtual < 4) {
                document.getElementById(`step${passoAtual}`).classList.remove('active');
                document.querySelectorAll('.step-circle')[passoAtual-1].classList.remove('active');
                
                passoAtual++;
                
                document.getElementById(`step${passoAtual}`).classList.add('active');
                document.querySelectorAll('.step-circle')[passoAtual-1].classList.add('active');
                
                salvarDados();
                atualizarResumo();
            }
        }
        
        function prevStep() {
            if (passoAtual > 1) {
                document.getElementById(`step${passoAtual}`).classList.remove('active');
                document.querySelectorAll('.step-circle')[passoAtual-1].classList.remove('active');
                
                passoAtual--;
                
                document.getElementById(`step${passoAtual}`).classList.add('active');
                document.querySelectorAll('.step-circle')[passoAtual-1].classList.add('active');
            }
        }
        
        // Salvar dados
        function salvarDados() {
            dados = {
                nome: document.getElementById('nome').value,
                matricula: document.getElementById('matricula').value,
                data: document.getElementById('data').value,
                municipio: document.getElementById('municipio').value,
                latitude: document.getElementById('latitude').value,
                longitude: document.getElementById('longitude').value,
                tipo: document.querySelector('input[name="tipo"]:checked')?.value,
                observacoes: document.getElementById('observacoes').value
            };
        }
        
        // Atualizar resumo
        function atualizarResumo() {
            salvarDados();
            let html = '';
            
            if (dados.nome) html += `<div class="summary-item"><strong>Pesquisador:</strong><br>${dados.nome}</div>`;
            if (dados.data) html += `<div class="summary-item"><strong>Data:</strong><br>${dados.data}</div>`;
            if (dados.municipio) html += `<div class="summary-item"><strong>Munic√≠pio:</strong><br>${dados.municipio}</div>`;
            if (dados.latitude && dados.longitude) html += `<div class="summary-item"><strong>Coordenadas:</strong><br>${dados.latitude}, ${dados.longitude}</div>`;
            if (dados.tipo) html += `<div class="summary-item"><strong>Tipo:</strong><br>${dados.tipo}</div>`;
            
            document.getElementById('resumo').innerHTML = html || 'Preencha o formul√°rio para ver o resumo aqui.';
        }
        
        // Salvar no armazenamento local
        function salvarLocal() {
            salvarDados();
            localStorage.setItem('iatFormData', JSON.stringify(dados));
            mostrarToast('Dados salvos localmente! ‚úÖ');
        }
        
        function carregarLocal() {
            const saved = localStorage.getItem('iatFormData');
            if (saved) {
                dados = JSON.parse(saved);
                
                // Preencher campos
                Object.keys(dados).forEach(key => {
                    const el = document.getElementById(key);
                    if (el) el.value = dados[key];
                    
                    // Para radios
                    if (key === 'tipo') {
                        document.querySelector(`input[name="tipo"][value="${dados.tipo}"]`).checked = true;
                    }
                });
                
                atualizarResumo();
                mostrarToast('Dados carregados! üìÇ');
            } else {
                mostrarToast('Nenhum dado salvo encontrado.', 'error');
            }
        }
        
        function limparFormulario() {
            if (confirm('Tem certeza que quer limpar todos os dados?')) {
                document.getElementById('iatForm').reset();
                limparAssinatura();
                localStorage.removeItem('iatFormData');
                dados = {};
                atualizarResumo();
                mostrarToast('Formul√°rio limpo! üóëÔ∏è');
            }
        }
        
        // Gerar PDF (simula√ß√£o)
        function gerarPDF() {
            if (!document.getElementById('termo').checked) {
                mostrarToast('Marque a confirma√ß√£o antes de gerar PDF.', 'error');
                return;
            }
            
            salvarLocal();
            mostrarToast('Gerando PDF IAT... ‚è≥');
            
            setTimeout(() => {
                // Criar link de download
                const nomeArquivo = `IAT_${dados.nome || 'Formulario'}_${new Date().toISOString().slice(0,10)}.pdf`;
                const blob = new Blob(['PDF Simulado - Em produ√ß√£o ser√° gerado PDF real do IAT'], {type: 'application/pdf'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = nomeArquivo;
                link.click();
                
                mostrarToast('PDF gerado com sucesso! üìÑ');
            }, 1500);
        }
        
        // Instalar PWA
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
        
        function instalarPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        mostrarToast('App instalado com sucesso! üì±');
                    }
                    deferredPrompt = null;
                });
            } else {
                mostrarToast('Use o menu do navegador para instalar', 'info');
            }
        }
        
        // Verificar conex√£o
        function atualizarConexao() {
            const status = document.getElementById('status');
            if (navigator.onLine) {
                status.innerHTML = '<i class="fas fa-wifi"></i> Online';
                status.style.background = 'rgba(56, 161, 105, 0.3)';
            } else {
                status.innerHTML = '<i class="fas fa-wifi-slash"></i> Offline';
                status.style.background = 'rgba(229, 62, 62, 0.3)';
            }
        }
        
        window.addEventListener('online', atualizarConexao);
        window.addEventListener('offline', atualizarConexao);
        atualizarConexao();
        
        // Toast messages
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${mensagem}`;
            toast.className = `toast show ${tipo}`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // Atualizar resumo ao digitar
        document.querySelectorAll('input, textarea, select').forEach(el => {
            el.addEventListener('input', atualizarResumo);
        });
        
        document.querySelectorAll('input[type="radio"]').forEach(el => {
            el.addEventListener('change', atualizarResumo);
        });
        
        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registrado'))
                .catch(err => console.log('Erro SW:', err));
        }
        
        // Inicializar
        atualizarResumo();
    </script>
</body>
</html>
