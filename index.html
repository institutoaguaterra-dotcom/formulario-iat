<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário IAT - 5 Documentos PDF Automáticos</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/pdf-lib@^1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/@pdf-lib/fontkit@^1.1.1/dist/fontkit.umd.min.js"></script>
    <style>
        :root {
            --iat-green: #2c7a47;
            --iat-green-light: #38a169;
            --iat-dark: #22543d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%); color: #2d3748; line-height: 1.6; padding: 20px; min-height: 100vh; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        header { 
            background: linear-gradient(135deg, var(--iat-green), var(--iat-dark));
            color: white; 
            padding: 30px; 
            border-radius: 15px 15px 0 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(44, 122, 71, 0.3);
            margin-bottom: 30px;
        }
        
        .logo-section { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .logo { font-size: 3.5rem; color: white; }
        .header-text h1 { font-size: 2.2rem; margin-bottom: 10px; font-weight: 700; }
        .header-text p { opacity: 0.9; font-size: 1.1rem; }
        
        .status-badge {
            background: rgba(255,255,255,0.15);
            padding: 8px 20px;
            border-radius: 25px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 992px) {
            .main-content { grid-template-columns: 1fr; }
        }
        
        .form-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
        }
        
        .pdf-panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            border-left: 6px solid var(--iat-green);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            color: var(--iat-dark);
            font-size: 1.4rem;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--iat-dark);
            font-size: 1rem;
        }
        
        .form-control {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--iat-green-light);
            box-shadow: 0 0 0 3px rgba(56, 161, 105, 0.2);
            background: white;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row { grid-template-columns: 1fr; }
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: #f0fff4;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .checkbox-label:hover {
            background: #e6fffa;
        }
        
        .pdf-cards {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }
        
        .pdf-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .pdf-card:hover {
            border-color: var(--iat-green-light);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .pdf-card.active {
            border-color: var(--iat-green);
            background: #f0fff4;
        }
        
        .pdf-icon {
            font-size: 2.5rem;
            color: var(--iat-green);
            margin-bottom: 15px;
        }
        
        .pdf-title {
            font-weight: 700;
            color: var(--iat-dark);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        
        .pdf-desc {
            color: #718096;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        .pdf-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            font-size: 0.85rem;
        }
        
        .pdf-status.complete {
            color: var(--iat-green);
        }
        
        .pdf-status.incomplete {
            color: #e53e3e;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        
        .btn-primary {
            background: var(--iat-green);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--iat-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(44, 122, 71, 0.4);
        }
        
        .btn-secondary {
            background: #4a5568;
            color: white;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-block {
            width: 100%;
        }
        
        .signature-container {
            margin-top: 20px;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            background: #fafafa;
        }
        
        #signatureCanvas {
            width: 100%;
            height: 150px;
            background: white;
            border-radius: 5px;
            cursor: crosshair;
        }
        
        .action-buttons {
            display: grid;
            gap: 15px;
            margin-top: 30px;
        }
        
        .data-preview {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 25px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .preview-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .preview-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .preview-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .preview-value {
            color: #2d3748;
            word-break: break-word;
        }
        
        footer {
            text-align: center;
            padding: 25px;
            background: white;
            border-radius: 15px;
            margin-top: 30px;
            color: #718096;
            box-shadow: 0 5px 25px rgba(0,0,0,0.05);
            border-top: 1px solid #e2e8f0;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 18px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
            transform: translateX(150%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            max-width: 400px;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success {
            background: var(--iat-green);
        }
        
        .toast.error {
            background: #e53e3e;
        }
        
        .toast.info {
            background: #3182ce;
        }
        
        .progress-container {
            background: #e2e8f0;
            border-radius: 10px;
            height: 10px;
            margin: 25px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--iat-green-light), var(--iat-green));
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .required::after {
            content: " *";
            color: #e53e3e;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <div class="logo">
                    <i class="fas fa-water"></i>
                </div>
                <div class="header-text">
                    <h1>Instituto Água e Terra - IAT</h1>
                    <p>Sistema Integrado de Preenchimento Automático de Formulários</p>
                    <div class="status-badge" id="statusIndicator">
                        <i class="fas fa-wifi"></i>
                        <span id="statusText">Conectado</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="progress-container">
            <div class="progress-bar" id="formProgress"></div>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 class="section-title">
                    <i class="fas fa-edit"></i> Dados da Pesquisa de Campo
                </h2>
                
                <div class="form-section">
                    <h3 class="section-title" style="font-size: 1.2rem;">
                        <i class="fas fa-user-circle"></i> Informações do Pesquisador
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Nome Completo</label>
                            <input type="text" id="pesquisadorNome" class="form-control" placeholder="Digite seu nome completo" data-pdf-field="F1.nome,F2.responsavel,F3.coletador,F4.tec_responsavel,F5.solicitante">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Matrícula IAT</label>
                            <input type="text" id="matriculaIAT" class="form-control" placeholder="Ex: IAT-12345" data-pdf-field="F1.matricula,F2.matricula_resp,F4.matricula_tecnico">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Data da Pesquisa</label>
                            <input type="date" id="dataPesquisa" class="form-control" data-pdf-field="F1.data,F2.data_vistoria,F3.data_coleta,F4.data_emissao,F5.data_solicitacao">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CPF</label>
                            <input type="text" id="cpfPesquisador" class="form-control" placeholder="000.000.000-00" data-pdf-field="F1.cpf,F4.cpf_tecnico">
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title" style="font-size: 1.2rem;">
                        <i class="fas fa-map-marked-alt"></i> Localização
                    </h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Município</label>
                            <input type="text" id="municipio" class="form-control" placeholder="Nome do município" data-pdf-field="F2.municipio,F3.local_coleta,F4.local_analise,F5.municipio_obra">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Bacia Hidrográfica</label>
                            <select id="baciaHidrografica" class="form-control" data-pdf-field="F2.bacia,F4.bacia_hidrografica">
                                <option value="">Selecione...</option>
                                <option value="Paraná">Bacia do Paraná</option>
                                <option value="Iguaçu">Bacia do Iguaçu</option>
                                <option value="Paranapanema">Bacia do Paranapanema</option>
                                <option value="Ivaí">Bacia do Ivaí</option>
                                <option value="Piquiri">Bacia do Piquiri</option>
                                <option value="Tibagi">Bacia do Tibagi</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label required">Latitude</label>
                            <input type="text" id="latitude" class="form-control" placeholder="-25.4284" data-pdf-field="F2.latitude,F3.coord_lat,F4.coordenada_lat">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Longitude</label>
                            <input type="text" id="longitude" class="form-control" placeholder="-49.2733" data-pdf-field="F2.longitude,F3.coord_long,F4.coordenada_long">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ponto de Referência</label>
                        <textarea id="pontoReferencia" class="form-control" rows="3" placeholder="Descreva pontos de referência para localização" data-pdf-field="F2.ponto_referencia,F3.referencia_local"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title" style="font-size: 1.2rem;">
                        <i class="fas fa-flask"></i> Parâmetros Avaliados
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label required">Tipo de Corpo Hídrico</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="radio" name="tipoCorpo" value="Rio" data-pdf-field="F2.tipo_corpo,F3.tipo_corpo,F4.tipo_recurso">
                                <span>Rio/Curso d'água</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="tipoCorpo" value="Lago/Lagoa" data-pdf-field="F2.tipo_corpo,F3.tipo_corpo,F4.tipo_recurso">
                                <span>Lago/Lagoa</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="tipoCorpo" value="Nascente" data-pdf-field="F2.tipo_corpo,F3.tipo_corpo,F4.tipo_recurso">
                                <span>Nascente</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="tipoCorpo" value="Reservatório" data-pdf-field="F2.tipo_corpo,F3.tipo_corpo,F4.tipo_recurso">
                                <span>Reservatório</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Parâmetros Analisados</label>
                        <div class="checkbox-group">
                            <label class="checkbox-label">
                                <input type="checkbox" value="pH" data-pdf-field="F3.parametros">
                                <span>pH</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="OD" data-pdf-field="F3.parametros">
                                <span>Oxigênio Dissolvido (OD)</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Turbidez" data-pdf-field="F3.parametros">
                                <span>Turbidez</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Condutividade" data-pdf-field="F3.parametros">
                                <span>Condutividade</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Temperatura" data-pdf-field="F3.parametros">
                                <span>Temperatura</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" value="Coliformes" data-pdf-field="F3.parametros">
                                <span>Coliformes</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Observações Técnicas</label>
                        <textarea id="observacoesTecnicas" class="form-control" rows="4" placeholder="Descreva as condições do local, anomalias encontradas, etc." data-pdf-field="F2.observacoes,F4.conclusoes,F5.condicoes"></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="section-title" style="font-size: 1.2rem;">
                        <i class="fas fa-signature"></i> Assinatura Digital
                    </h3>
                    
                    <div class="signature-container">
                        <p class="form-label">Assine no quadro abaixo:</p>
                        <canvas id="signatureCanvas"></canvas>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button type="button" class="btn btn-secondary" onclick="clearSignature()">
                                <i class="fas fa-eraser"></i> Limpar Assinatura
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="saveSignature()">
                                <i class="fas fa-save"></i> Salvar Assinatura
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pdf-panel">
                <h2 class="section-title">
                    <i class="fas fa-file-pdf"></i> Documentos IAT
                </h2>
                <p style="color: #718096; margin-bottom: 25px;">Os 5 formulários serão preenchidos automaticamente conforme você digita.</p>
                
                <div class="pdf-cards">
                    <div class="pdf-card active" onclick="selectPDF(1)" id="pdfCard1">
                        <div class="pdf-icon">
                            <i class="fas fa-file-contract"></i>
                        </div>
                        <div class="pdf-title">F1 - Declaração de Atividade</div>
                        <div class="pdf-desc">Declaração de atividades ambientais realizadas em campo</div>
                        <div class="pdf-status incomplete" id="pdfStatus1">
                            <i class="fas fa-clock"></i> <span>Aguardando dados</span>
                        </div>
                    </div>
                    
                    <div class="pdf-card" onclick="selectPDF(2)" id="pdfCard2">
                        <div class="pdf-icon">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="pdf-title">F2 - Relatório de Vistoria</div>
                        <div class="pdf-desc">Registro detalhado da vistoria técnica realizada</div>
                        <div class="pdf-status incomplete" id="pdfStatus2">
                            <i class="fas fa-clock"></i> <span>Aguardando dados</span>
                        </div>
                    </div>
                    
                    <div class="pdf-card" onclick="selectPDF(3)" id="pdfCard3">
                        <div class="pdf-icon">
                            <i class="fas fa-vial"></i>
                        </div>
                        <div class="pdf-title">F3 - Coleta de Amostras</div>
                        <div class="pdf-desc">Registro de coleta de amostras para análise laboratorial</div>
                        <div class="pdf-status incomplete" id="pdfStatus3">
                            <i class="fas fa-clock"></i> <span>Aguardando dados</span>
                        </div>
                    </div>
                    
                    <div class="pdf-card" onclick="selectPDF(4)" id="pdfCard4">
                        <div class="pdf-icon">
                            <i class="fas fa-file-medical-alt"></i>
                        </div>
                        <div class="pdf-title">F4 - Laudo Técnico</div>
                        <div class="pdf-desc">Laudo técnico com análises e conclusões</div>
                        <div class="pdf-status incomplete" id="pdfStatus4">
                            <i class="fas fa-clock"></i> <span>Aguardando dados</span>
                        </div>
                    </div>
                    
                    <div class="pdf-card" onclick="selectPDF(5)" id="pdfCard5">
                        <div class="pdf-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="pdf-title">F5 - Autorização Ambiental</div>
                        <div class="pdf-desc">Solicitação de autorização ambiental para atividades</div>
                        <div class="pdf-status incomplete" id="pdfStatus5">
                            <i class="fas fa-clock"></i> <span>Aguardando dados</span>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-success btn-block" onclick="generateAllPDFs()">
                        <i class="fas fa-download"></i> Gerar Todos os PDFs
                    </button>
                    <button class="btn btn-primary btn-block" onclick="generateSelectedPDF()">
                        <i class="fas fa-file-export"></i> Gerar PDF Selecionado
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="saveAllData()">
                        <i class="fas fa-database"></i> Salvar Todos os Dados
                    </button>
                    <button class="btn btn-secondary btn-block" onclick="clearAllData()">
                        <i class="fas fa-broom"></i> Limpar Todos os Dados
                    </button>
                </div>
                
                <div class="data-preview">
                    <h3 style="color: var(--iat-dark); margin-bottom: 15px; font-size: 1.1rem;">
                        <i class="fas fa-eye"></i> Visualização dos Dados
                    </h3>
                    <div id="dataPreview">
                        <p style="color: #a0aec0; font-style: italic;">Os dados aparecerão aqui conforme preenchimento...</p>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p><strong>Instituto Água e Terra - IAT</strong> | Secretaria do Desenvolvimento Sustentável e do Turismo</p>
            <p>Sistema de Preenchimento Automático de Formulários | Versão 1.0</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <i class="fas fa-info-circle"></i> Os 5 formulários PDF são preenchidos automaticamente em tempo real
            </p>
        </footer>
    </div>

    <div class="toast" id="toastMessage"></div>

    <script>
        // ================= CONFIGURAÇÃO INICIAL =================
        let formData = {
            F1: {}, F2: {}, F3: {}, F4: {}, F5: {}
        };
        
        let selectedPDF = 1;
        let signatureData = null;
        let isDrawing = false;
        const ctx = document.getElementById('signatureCanvas').getContext('2d');
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar assinatura
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';
            
            // Configurar canvas
            const canvas = document.getElementById('signatureCanvas');
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            
            // Data atual como padrão
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dataPesquisa').value = today;
            
            // Atualizar dados em tempo real
            document.querySelectorAll('input, textarea, select').forEach(element => {
                element.addEventListener('input', updateFormData);
                element.addEventListener('change', updateFormData);
            });
            
            // Carregar dados salvos
            loadSavedData();
            
            // Atualizar status de conexão
            updateConnectionStatus();
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
        });
        
        // ================= ATUALIZAÇÃO DE DADOS EM TEMPO REAL =================
        function updateFormData() {
            // Coletar todos os dados do formulário
            const fieldMapping = {
                pesquisadorNome: ['F1.nome', 'F2.responsavel', 'F3.coletador', 'F4.tec_responsavel', 'F5.solicitante'],
                matriculaIAT: ['F1.matricula', 'F2.matricula_resp', 'F4.matricula_tecnico'],
                dataPesquisa: ['F1.data', 'F2.data_vistoria', 'F3.data_coleta', 'F4.data_emissao', 'F5.data_solicitacao'],
                cpfPesquisador: ['F1.cpf', 'F4.cpf_tecnico'],
                municipio: ['F2.municipio', 'F3.local_coleta', 'F4.local_analise', 'F5.municipio_obra'],
                baciaHidrografica: ['F2.bacia', 'F4.bacia_hidrografica'],
                latitude: ['F2.latitude', 'F3.coord_lat', 'F4.coordenada_lat'],
                longitude: ['F2.longitude', 'F3.coord_long', 'F4.coordenada_long'],
                pontoReferencia: ['F2.ponto_referencia', 'F3.referencia_local'],
                observacoesTecnicas: ['F2.observacoes', 'F4.conclusoes', 'F5.condicoes']
            };
            
            // Atualizar cada campo
            Object.keys(fieldMapping).forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    const value = element.value;
                    fieldMapping[fieldId].forEach(pdfField => {
                        const [form, field] = pdfField.split('.');
                        if (form && field) {
                            formData[form][field] = value;
                        }
                    });
                }
            });
            
            // Tratar radios (tipo de corpo hídrico)
            const tipoCorpo = document.querySelector('input[name="tipoCorpo"]:checked');
            if (tipoCorpo) {
                formData.F2.tipo_corpo = tipoCorpo.value;
                formData.F3.tipo_corpo = tipoCorpo.value;
                formData.F4.tipo_recurso = tipoCorpo.value;
            }
            
            // Tratar checkboxes (parâmetros)
            const parametros = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value)
                .join(', ');
            formData.F3.parametros = parametros;
            
            // Atualizar visualização e status
            updateDataPreview();
            updatePDFStatus();
            updateProgress();
            saveToLocalStorage();
        }
        
        // ================= VISUALIZAÇÃO DE DADOS =================
        function updateDataPreview() {
            const preview = document.getElementById('dataPreview');
            let html = '';
            
            // Dados básicos
            if (formData.F1.nome) {
                html += `<div class="preview-item">
                    <div class="preview-label">Pesquisador:</div>
                    <div class="preview-value">${formData.F1.nome}</div>
                </div>`;
            }
            
            if (formData.F1.matricula) {
                html += `<div class="preview-item">
                    <div class="preview-label">Matrícula IAT:</div>
                    <div class="preview-value">${formData.F1.matricula}</div>
                </div>`;
            }
            
            if (formData.F2.municipio) {
                html += `<div class="preview-item">
                    <div class="preview-label">Município:</div>
                    <div class="preview-value">${formData.F2.municipio}</div>
                </div>`;
            }
            
            if (formData.F2.latitude && formData.F2.longitude) {
                html += `<div class="preview-item">
                    <div class="preview-label">Coordenadas:</div>
                    <div class="preview-value">${formData.F2.latitude}, ${formData.F2.longitude}</div>
                </div>`;
            }
            
            if (formData.F2.tipo_corpo) {
                html += `<div class="preview-item">
                    <div class="preview-label">Tipo de Corpo Hídrico:</div>
                    <div class="preview-value">${formData.F2.tipo_corpo}</div>
                </div>`;
            }
            
            preview.innerHTML = html || '<p style="color: #a0aec0; font-style: italic;">Os dados aparecerão aqui conforme preenchimento...</p>';
        }
        
        // ================= STATUS DOS PDFs =================
        function updatePDFStatus() {
            for (let i = 1; i <= 5; i++) {
                const formKey = `F${i}`;
                const statusElement = document.getElementById(`pdfStatus${i}`);
                const cardElement = document.getElementById(`pdfCard${i}`);
                
                const requiredFields = getRequiredFields(formKey);
                const completedFields = requiredFields.filter(field => 
                    formData[formKey][field] && formData[formKey][field].toString().trim() !== ''
                );
                
                const completionRate = requiredFields.length > 0 
                    ? (completedFields.length / requiredFields.length) * 100 
                    : 0;
                
                if (completionRate >= 100) {
                    statusElement.innerHTML = `<i class="fas fa-check-circle"></i> <span>Completo (100%)</span>`;
                    statusElement.className = 'pdf-status complete';
                } else if (completionRate > 0) {
                    statusElement.innerHTML = `<i class="fas fa-spinner"></i> <span>${Math.round(completionRate)}% preenchido</span>`;
                    statusElement.className = 'pdf-status complete';
                } else {
                    statusElement.innerHTML = `<i class="fas fa-clock"></i> <span>Aguardando dados</span>`;
                    statusElement.className = 'pdf-status incomplete';
                }
                
                // Destacar card do PDF selecionado
                if (i === selectedPDF) {
                    cardElement.classList.add('active');
                } else {
                    cardElement.classList.remove('active');
                }
            }
        }
        
        function getRequiredFields(formKey) {
            const fieldRequirements = {
                F1: ['nome', 'matricula', 'data', 'cpf'],
                F2: ['responsavel', 'matricula_resp', 'data_vistoria', 'municipio', 'latitude', 'longitude'],
                F3: ['coletador', 'data_coleta', 'local_coleta', 'tipo_corpo'],
                F4: ['tec_responsavel', 'matricula_tecnico', 'data_emissao', 'local_analise', 'conclusoes'],
                F5: ['solicitante', 'data_solicitacao', 'municipio_obra']
            };
            return fieldRequirements[formKey] || [];
        }
        
        // ================= BARRA DE PROGRESSO =================
        function updateProgress() {
            let totalFields = 0;
            let completedFields = 0;
            
            for (let i = 1; i <= 5; i++) {
                const formKey = `F${i}`;
                const requiredFields = getRequiredFields(formKey);
                totalFields += requiredFields.length;
                
                completedFields += requiredFields.filter(field => 
                    formData[formKey][field] && formData[formKey][field].toString().trim() !== ''
                ).length;
            }
            
            const progress = totalFields > 0 ? (completedFields / totalFields) * 100 : 0;
            document.getElementById('formProgress').style.width = `${progress}%`;
        }
        
        // ================= ASSINATURA DIGITAL =================
        function startDrawing(e) {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
        
        function stopDrawing() {
            isDrawing = false;
            signatureData = document.getElementById('signatureCanvas').toDataURL();
            
            // Adicionar assinatura a todos os formulários
            for (let i = 1; i <= 5; i++) {
                formData[`F${i}`].assinatura = signatureData;
            }
            
            saveToLocalStorage();
            showToast('Assinatura salva com sucesso!', 'success');
        }
        
        function clearSignature() {
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            signatureData = null;
            
            for (let i = 1; i <= 5; i++) {
                delete formData[`F${i}`].assinatura;
            }
            
            showToast('Assinatura removida!', 'info');
        }
        
        function saveSignature() {
            if (!signatureData) {
                showToast('Desenhe uma assinatura primeiro!', 'error');
                return;
            }
            showToast('Assinatura já está salva!', 'success');
        }
        
        // ================= GERAR PDFs =================
        function selectPDF(pdfNumber) {
            selectedPDF = pdfNumber;
            
            // Atualizar cards
            document.querySelectorAll('.pdf-card').forEach(card => {
                card.classList.remove('active');
            });
            document.getElementById(`pdfCard${pdfNumber}`).classList.add('active');
            
            showToast(`PDF F${pdfNumber} selecionado`, 'info');
        }
        
        async function generateSelectedPDF() {
            const formKey = `F${selectedPDF}`;
            const requiredFields = getRequiredFields(formKey);
            const missingFields = requiredFields.filter(field => 
                !formData[formKey][field] || formData[formKey][field].toString().trim() === ''
            );
            
            if (missingFields.length > 0) {
                showToast(`Preencha os campos obrigatórios do F${selectedPDF} primeiro!`, 'error');
                return;
            }
            
            showToast(`Gerando PDF F${selectedPDF}...`, 'info');
            
            // Simular geração de PDF
            setTimeout(() => {
                const pdfName = `IAT_Formulario_F${selectedPDF}_${new Date().toISOString().slice(0,10)}.pdf`;
                downloadSimulatedPDF(pdfName, formData[formKey]);
                showToast(`PDF F${selectedPDF} gerado com sucesso!`, 'success');
            }, 1500);
        }
        
        async function generateAllPDFs() {
            let hasIncomplete = false;
            
            for (let i = 1; i <= 5; i++) {
                const formKey = `F${i}`;
                const requiredFields = getRequiredFields(formKey);
                const missingFields = requiredFields.filter(field => 
                    !formData[formKey][field] || formData[formKey][field].toString().trim() === ''
                );
                
                if (missingFields.length > 0) {
                    hasIncomplete = true;
                    break;
                }
            }
            
            if (hasIncomplete) {
                showToast('Complete todos os formulários antes de gerar!', 'error');
                return;
            }
            
            showToast('Gerando todos os 5 PDFs...', 'info');
            
            // Simular geração de múltiplos PDFs
            setTimeout(() => {
                for (let i = 1; i <= 5; i++) {
                    const formKey = `F${i}`;
                    const pdfName = `IAT_Formulario_F${i}_${new Date().toISOString().slice(0,10)}.pdf`;
                    
                    // Em produção real, aqui você geraria o PDF com pdf-lib
                    setTimeout(() => {
                        downloadSimulatedPDF(pdfName, formData[formKey]);
                    }, i * 300);
                }
                
                showToast('Todos os 5 PDFs foram gerados!', 'success');
            }, 2000);
        }
        
        function downloadSimulatedPDF(filename, data) {
            // Em produção real, substitua por geração real com pdf-lib
            const content = `=== FORMULÁRIO IAT ===\n\n`;
            let textContent = content + JSON.stringify(data, null, 2);
            
            const blob = new Blob([textContent], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // ================= ARMAZENAMENTO LOCAL =================
        function saveToLocalStorage() {
            localStorage.setItem('iatFormDataAll', JSON.stringify(formData));
            localStorage.setItem('iatSignature', signatureData);
        }
        
        function loadSavedData() {
            const savedData = localStorage.getItem('iatFormDataAll');
            const savedSignature = localStorage.getItem('iatSignature');
            
            if (savedData) {
                formData = JSON.parse(savedData);
                
                // Preencher campos do formulário
                document.getElementById('pesquisadorNome').value = formData.F1.nome || '';
                document.getElementById('matriculaIAT').value = formData.F1.matricula || '';
                document.getElementById('dataPesquisa').value = formData.F1.data || '';
                document.getElementById('cpfPesquisador').value = formData.F1.cpf || '';
                document.getElementById('municipio').value = formData.F2.municipio || '';
                document.getElementById('baciaHidrografica').value = formData.F2.bacia || '';
                document.getElementById('latitude').value = formData.F2.latitude || '';
                document.getElementById('longitude').value = formData.F2.longitude || '';
                document.getElementById('pontoReferencia').value = formData.F2.ponto_referencia || '';
                document.getElementById('observacoesTecnicas').value = formData.F2.observacoes || '';
                
                // Preencher radios
                if (formData.F2.tipo_corpo) {
                    document.querySelector(`input[name="tipoCorpo"][value="${formData.F2.tipo_corpo}"]`).checked = true;
                }
                
                // Preencher checkboxes
                if (formData.F3.parametros) {
                    const params = formData.F3.parametros.split(', ');
                    document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        cb.checked = params.includes(cb.value);
                    });
                }
                
                // Carregar assinatura
                if (savedSignature) {
                    signatureData = savedSignature;
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = savedSignature;
                }
                
                updateDataPreview();
                updatePDFStatus();
                updateProgress();
                showToast('Dados anteriores carregados!', 'success');
            }
        }
        
        function saveAllData() {
            saveToLocalStorage();
            showToast('Todos os dados foram salvos localmente!', 'success');
        }
        
        function clearAllData() {
            if (confirm('Tem certeza que deseja limpar TODOS os dados? Isso não poderá ser desfeito.')) {
                formData = { F1: {}, F2: {}, F3: {}, F4: {}, F5: {} };
                localStorage.removeItem('iatFormDataAll');
                localStorage.removeItem('iatSignature');
                document.getElementById('iatForm').reset();
                clearSignature();
                updateDataPreview();
                updatePDFStatus();
                updateProgress();
                showToast('Todos os dados foram removidos!', 'info');
            }
        }
        
        // ================= UTILITÁRIOS =================
        function updateConnectionStatus() {
            const statusElement = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (navigator.onLine) {
                statusText.textContent = 'Conectado';
                statusElement.style.background = 'rgba(56, 161, 105, 0.3)';
            } else {
                statusText.textContent = 'Offline';
                statusElement.style.background = 'rgba(229, 62, 62, 0.3)';
            }
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastMessage');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-exclamation-circle';
            
            toast.innerHTML = `<i class="${icon}"></i> ${message}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        
        // ================= SERVICE WORKER PARA OFFLINE =================
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registrado:', reg))
                .catch(err => console.log('Erro no Service Worker:', err));
        }
    </script>
</body>
</html>
