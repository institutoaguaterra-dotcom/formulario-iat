<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário 3 - Vistoria Aérea</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            font-size: 12pt;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .header-form {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #805ad5;
        }
        
        .header-form h1 {
            font-size: 16pt;
            color: #2c7a47;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .header-form h2 {
            font-size: 14pt;
            color: #444;
            margin-bottom: 5px;
        }
        
        .section {
            margin: 30px 0;
        }
        
        .section-title {
            background: #805ad5;
            color: white;
            padding: 10px 15px;
            font-size: 13pt;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .section-title button {
            background: rgba(255,255,255,0.2);
            border: 1px solid white;
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11pt;
        }
        
        .info-group {
            margin-bottom: 20px;
        }
        
        .info-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }
        
        .info-group input, .info-group textarea, .info-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12pt;
        }
        
        .info-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .coordenadas-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #805ad5;
        }
        
        .coordenada-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .add-coordenada {
            margin-top: 10px;
            padding: 8px 15px;
            background: #805ad5;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .image-section {
            margin: 30px 0;
        }
        
        .image-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            margin: 20px 0;
        }
        
        .image-upload:hover {
            border-color: #805ad5;
            background: #f5f0ff;
        }
        
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .image-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        
        .image-info {
            padding: 10px;
            background: #f9f9f9;
        }
        
        .image-info input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-bottom: 5px;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .participantes-section {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .participante-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .participante-item input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 12pt;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-primary {
            background: #805ad5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #6b46c1;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background: #2c7a47;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background: #805ad5;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .container {
                padding: 15px;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho do Formulário -->
        <div class="header-form">
            <h1>ESCRITÓRIO REGIONAL DE CURITIBA</h1>
            <h2>SETOR DE LICENCIAMENTO DE ENERGIA</h2>
            <h3>RELATÓRIO DE VISTORIA AÉREA</h3>
        </div>
        
        <!-- Seção 1: Introdução -->
        <div class="section">
            <div class="section-title">
                <span>1. INTRODUÇÃO</span>
                <button onclick="preencherIntroducao()">Preencher Automático</button>
            </div>
            <div class="info-group">
                <textarea id="introducao">O presente relatório tem por finalidade apresentar os resultados das vistorias técnicas realizadas nos processos de licenciamento e autorizações florestais de empreendimentos de Geração, Transmissão e Distribuição de Energia Elétrica, com foco na verificação das conformidades das informações prestadas nos referidos processos, com vista à elaboração de Parecer Técnico que embasará a decisão administrativa quanto ao licenciamento para a realização das obras requeridas a este IAT.</textarea>
            </div>
            <div class="info-group">
                <label for="data_vistoria">Data da Vistoria:</label>
                <input type="date" id="data_vistoria" required>
            </div>
            <div class="info-group">
                <textarea id="introducao_continuacao">A vistoria foi realizada no dia [DATA], em sobrevoo nas áreas de interesse apresentadas nos processos de licenciamento ambiental.</textarea>
            </div>
        </div>
        
        <!-- Seção 2: Objetivo -->
        <div class="section">
            <div class="section-title">
                <span>2. OBJETIVO</span>
                <button onclick="preencherObjetivo()">Preencher Automático</button>
            </div>
            <div class="info-group">
                <textarea id="objetivo">Verificar a conformidade das informações apresentadas pelos requerentes nos processos de licenciamento ambiental, com a finalidade de assegurar que as atividades a serem licenciadas estejam de acordo com as exigências legais, ambientais e normativas vigentes.</textarea>
            </div>
        </div>
        
        <!-- Seção 3: Metodologia -->
        <div class="section">
            <div class="section-title">
                <span>3. METODOLOGIA</span>
                <button onclick="preencherMetodologia()">Preencher Automático</button>
            </div>
            <div class="info-group">
                <textarea id="metodologia">As vistorias técnicas foram conduzidas com base na análise dos seguintes aspectos:

• Verificação in loco das atividades realizadas;
• Relatório de Automonitoramento, Relatório de Atendimento das Condicionantes da Licença Anterior, incidência de impeditivos ambientais nas áreas de interesse e não conformidades ambientais.</textarea>
            </div>
            
            <!-- Participantes da Vistoria -->
            <div class="participantes-section">
                <h4>Participantes da Vistoria:</h4>
                <div id="participantesContainer">
                    <!-- Participantes serão adicionados dinamicamente -->
                </div>
                <button type="button" onclick="adicionarParticipante()" class="add-coordenada">
                    <i class="fas fa-user-plus"></i> Adicionar Participante
                </button>
            </div>
        </div>
        
        <!-- Seção 4: Localização e Contexto -->
        <div class="section">
            <div class="section-title">
                <span>4. LOCALIZAÇÃO E CONTEXTO DA VISTORIA</span>
            </div>
            <div class="info-group">
                <label for="protocolo">Número do Protocolo:</label>
                <input type="text" id="protocolo" placeholder="Ex: 2024.12345.123-4" required>
            </div>
            <div class="info-group">
                <label for="tipo_licenciamento">Tipo de Licenciamento:</label>
                <select id="tipo_licenciamento">
                    <option value="">Selecione...</option>
                    <option value="LO">Licença de Operação (LO)</option>
                    <option value="LP">Licença Prévia (LP)</option>
                    <option value="LI">Licença de Instalação (LI)</option>
                    <option value="LA">Licença Ambiental (LA)</option>
                    <option value="AU">Autorização Florestal</option>
                </select>
            </div>
            <div class="info-group">
                <label for="descricao_empreendimento">Descrição do Empreendimento:</label>
                <textarea id="descricao_empreendimento" placeholder="Ex: Solicitação de RENOVAÇÃO DE LICENÇA DE OPERAÇÃO (LO) da Linha de Transmissão XXXXXX, XX kV de tensão, interliga Subestação XXXX, no município de XXXXX, à Subestação XXXX..."></textarea>
            </div>
            
            <!-- Coordenadas UTM -->
            <div class="coordenadas-group">
                <h4>Coordenadas Geográficas UTM (SIRGAS 2000) 22J:</h4>
                <div id="coordenadasContainer">
                    <!-- Coordenadas serão adicionadas dinamicamente -->
                </div>
                <button type="button" onclick="adicionarCoordenada()" class="add-coordenada">
                    <i class="fas fa-map-marker-alt"></i> Adicionar Coordenada
                </button>
            </div>
        </div>
        
        <!-- Seção 5: Registros Fotográficos -->
        <div class="section image-section">
            <div class="section-title">
                <span>5. REGISTROS FOTOGRÁFICOS</span>
            </div>
            
            <div class="info-group">
                <label for="titulo_fotos">Título das Fotos:</label>
                <input type="text" id="titulo_fotos" placeholder="Ex: Linha de Transmissão XXXXXX, XXX kV" required>
            </div>
            
            <div class="image-upload" onclick="document.getElementById('fileInput').click()">
                <i class="fas fa-camera fa-3x" style="color: #805ad5; margin-bottom: 15px;"></i>
                <h4>Clique para adicionar fotos da vistoria aérea</h4>
                <p>Adicione até 15 imagens (máx. 5MB cada)</p>
                <p style="font-size: 10pt; color: #888;">Formato: JPG, PNG</p>
            </div>
            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;" onchange="adicionarImagens(event)">
            
            <div class="image-grid" id="imageGrid">
                <!-- Imagens serão adicionadas dinamicamente -->
            </div>
        </div>
        
        <!-- Seção 6: Conclusão -->
        <div class="section">
            <div class="section-title">
                <span>6. CONCLUSÃO</span>
                <button onclick="preencherConclusao()">Preencher Automático</button>
            </div>
            <div class="info-group">
                <label for="nome_lt">Nome da Linha de Transmissão:</label>
                <input type="text" id="nome_lt" placeholder="Ex: Linha de Transmissão xxxxxx" required>
            </div>
            <div class="info-group">
                <label for="tensao_lt">Tensão (kV):</label>
                <input type="text" id="tensao_lt" placeholder="Ex: 230, 138, 69" required>
            </div>
            <div class="info-group">
                <label for="licenca_numero">Número da Licença:</label>
                <input type="text" id="licenca_numero" placeholder="Ex: 1234/2023" required>
            </div>
            <div class="info-group">
                <textarea id="conclusao" placeholder="Descreva a conclusão da vistoria...">A Linha de Transmissão [NOME] está em operação regularmente com Licença nº [NÚMERO], e requerimento de Renovação de Licença de Operação, protocolo nº [PROTOCOLO]. A documentação apresentada no processo está [SITUAÇÃO], sendo necessário apresentar a situação atual da área onde a LT se encontra. 
Durante a vistoria in loco foi possível verificar que em alguns vãos da LT a faixa de servidão possui construções, agricultura, vegetação nativa preservada, além de intersectar estradas e rodovias.
As torres na sua maioria apresentam na base vegetação, indicando que não há problemas com erosão do solo.</textarea>
            </div>
        </div>
        
        <!-- Assinatura -->
        <div class="section">
            <div class="section-title">
                <span>ASSINATURA</span>
            </div>
            <div class="info-group">
                <div style="text-align: center; padding: 20px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;">
                    <div style="margin-bottom: 20px;">
                        <canvas id="assinaturaCanvas" width="600" height="150" style="border: 1px dashed #ccc; background: white; cursor: crosshair;"></canvas>
                        <div style="margin-top: 10px;">
                            <button type="button" onclick="limparAssinatura()" style="padding: 8px 15px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                            <button type="button" onclick="salvarAssinatura()" style="padding: 8px 15px; background: #805ad5; color: white; border: none; border-radius: 3px; cursor: pointer;">
                                <i class="fas fa-save"></i> Salvar Assinatura
                            </button>
                        </div>
                    </div>
                    
                    <div style="text-align: left; max-width: 400px; margin: 0 auto;">
                        <div class="info-group">
                            <label for="nome_responsavel">Nome do Responsável:</label>
                            <input type="text" id="nome_responsavel" value="JÉSSICA ANAHÍ RABERY" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="info-group">
                            <label for="cargo_responsavel">Cargo/Função:</label>
                            <input type="text" id="cargo_responsavel" value="Engenheira Química | Bolsista" readonly style="background: #f0f0f0;">
                        </div>
                        <div class="info-group">
                            <label for="setor_responsavel">Setor:</label>
                            <input type="text" id="setor_responsavel" value="Licenciamento de Energia – ERCBA" readonly style="background: #f0f0f0;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="buttons">
            <button class="btn btn-secondary" onclick="window.location.href = 'index.html'">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="btn btn-primary" onclick="salvarFormulario()">
                <i class="fas fa-save"></i> Salvar Rascunho
            </button>
            <button class="btn btn-success" onclick="gerarPDF()">
                <i class="fas fa-file-pdf"></i> Gerar PDF
            </button>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // Dados do formulário
        let dadosFormulario = {
            introducao: '',
            data_vistoria: '',
            objetivo: '',
            metodologia: '',
            participantes: [],
            protocolo: '',
            tipo_licenciamento: '',
            descricao_empreendimento: '',
            coordenadas: [],
            titulo_fotos: '',
            imagens: [],
            nome_lt: '',
            tensao_lt: '',
            licenca_numero: '',
            conclusao: '',
            assinatura: null,
            responsavel: {
                nome: 'JÉSSICA ANAHÍ RABERY',
                cargo: 'Engenheira Química | Bolsista',
                setor: 'Licenciamento de Energia – ERCBA'
            }
        };
        
        // Configurar canvas de assinatura
        const canvas = document.getElementById('assinaturaCanvas');
        const ctx = canvas.getContext('2d');
        let desenhando = false;
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Data atual
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data_vistoria').value = hoje;
            
            // Configurar canvas
            ctx.strokeStyle = '#805ad5';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Eventos do canvas
            canvas.addEventListener('mousedown', iniciarDesenho);
            canvas.addEventListener('mousemove', desenhar);
            canvas.addEventListener('mouseup', pararDesenho);
            
            // Carregar dados salvos
            carregarDados();
            
            // Adicionar coordenada inicial
            adicionarCoordenada();
            
            // Adicionar participante inicial
            adicionarParticipante();
        });
        
        // Funções de assinatura
        function iniciarDesenho(e) {
            desenhando = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }
        
        function desenhar(e) {
            if (!desenhando) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
        
        function pararDesenho() {
            desenhando = false;
        }
        
        function limparAssinatura() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            dadosFormulario.assinatura = null;
        }
        
        function salvarAssinatura() {
            dadosFormulario.assinatura = canvas.toDataURL();
            mostrarToast('Assinatura salva com sucesso!', 'success');
        }
        
        // Preenchimento automático
        function preencherIntroducao() {
            const hoje = new Date();
            const dataFormatada = hoje.toLocaleDateString('pt-BR', { 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric' 
            });
            
            document.getElementById('introducao_continuacao').value = 
                `A vistoria foi realizada no dia ${dataFormatada}, em sobrevoo nas áreas de interesse apresentadas nos processos de licenciamento ambiental.`;
            
            mostrarToast('Introdução preenchida automaticamente', 'success');
        }
        
        function preencherObjetivo() {
            document.getElementById('objetivo').value = 
                'Verificar a conformidade das informações apresentadas pelos requerentes nos processos de licenciamento ambiental, com a finalidade de assegurar que as atividades a serem licenciadas estejam de acordo com as exigências legais, ambientais e normativas vigentes.';
            
            mostrarToast('Objetivo preenchido automaticamente', 'success');
        }
        
        function preencherMetodologia() {
            document.getElementById('metodologia').value = 
                `As vistorias técnicas foram conduzidas com base na análise dos seguintes aspectos:

• Verificação in loco das atividades realizadas;
• Relatório de Automonitoramento, Relatório de Atendimento das Condicionantes da Licença Anterior, incidência de impeditivos ambientais nas áreas de interesse e não conformidades ambientais.

A vistoria realizada no dia ${new Date().toLocaleDateString('pt-BR')} teve a participação dos técnicos do Setor de Licenciamento de Energia.`;
            
            mostrarToast('Metodologia preenchida automaticamente', 'success');
        }
        
        function preencherConclusao() {
            const protocolo = document.getElementById('protocolo').value || '[PROTOCOLO]';
            const nomeLT = document.getElementById('nome_lt').value || '[NOME]';
            const numeroLicenca = document.getElementById('licenca_numero').value || '[NÚMERO]';
            
            document.getElementById('conclusao').value = 
                `A ${nomeLT} está em operação regularmente com Licença nº ${numeroLicenca}, e requerimento de Renovação de Licença de Operação, protocolo nº ${protocolo}. A documentação apresentada no processo está atualizada, sendo necessário apresentar a situação atual da área onde a LT se encontra. 
Durante a vistoria in loco foi possível verificar que em alguns vãos da LT a faixa de servidão possui construções, agricultura, vegetação nativa preservada, além de intersectar estradas e rodovias.
As torres na sua maioria apresentam na base vegetação, indicando que não há problemas com erosão do solo.`;
            
            mostrarToast('Conclusão preenchida automaticamente', 'success');
        }
        
        // Coordenadas
        function adicionarCoordenada() {
            const container = document.getElementById('coordenadasContainer');
            const index = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'coordenada-item';
            div.innerHTML = `
                <div style="display: flex; gap: 10px; align-items: center;">
                    <div style="flex: 1;">
                        <label style="font-size: 10pt;">Descrição:</label>
                        <input type="text" 
                               id="coord_desc_${index}" 
                               placeholder="Ex: Início da LT, Torre 1, etc."
                               oninput="atualizarCoordenada(${index}, 'descricao', this.value)"
                               style="width: 100%; padding: 8px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 10pt;">Coordenada E (Este):</label>
                        <input type="text" 
                               id="coord_e_${index}" 
                               placeholder="Ex: 123456 m E"
                               oninput="atualizarCoordenada(${index}, 'este', this.value)"
                               style="width: 100%; padding: 8px;">
                    </div>
                    <div style="flex: 1;">
                        <label style="font-size: 10pt;">Coordenada S (Sul):</label>
                        <input type="text" 
                               id="coord_s_${index}" 
                               placeholder="Ex: 7890123 m S"
                               oninput="atualizarCoordenada(${index}, 'sul', this.value)"
                               style="width: 100%; padding: 8px;">
                    </div>
                    <button type="button" onclick="removerCoordenada(${index})" style="background: #e53e3e; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; cursor: pointer;">
                        ×
                    </button>
                </div>
            `;
            
            container.appendChild(div);
        }
        
        function atualizarCoordenada(index, campo, valor) {
            if (!dadosFormulario.coordenadas[index]) {
                dadosFormulario.coordenadas[index] = { descricao: '', este: '', sul: '' };
            }
            dadosFormulario.coordenadas[index][campo] = valor;
        }
        
        function removerCoordenada(index) {
            const container = document.getElementById('coordenadasContainer');
            if (container.children[index]) {
                container.children[index].remove();
            }
            dadosFormulario.coordenadas.splice(index, 1);
            // Reindexar
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                items[i].querySelectorAll('input').forEach((input, j) => {
                    const oldId = input.id;
                    const newId = oldId.replace(/_\d+/, `_${i}`);
                    input.id = newId;
                    input.oninput = function() {
                        const campo = input.id.includes('desc') ? 'descricao' : 
                                     input.id.includes('e_') ? 'este' : 'sul';
                        atualizarCoordenada(i, campo, this.value);
                    };
                });
                items[i].querySelector('button').onclick = function() {
                    removerCoordenada(i);
                };
            }
        }
        
        // Participantes
        function adicionarParticipante() {
            const container = document.getElementById('participantesContainer');
            const index = container.children.length;
            
            const div = document.createElement('div');
            div.className = 'participante-item';
            div.innerHTML = `
                <input type="text" 
                       id="part_funcao_${index}" 
                       placeholder="Função/Cargo"
                       oninput="atualizarParticipante(${index}, 'funcao', this.value)">
                <input type="text" 
                       id="part_nome_${index}" 
                       placeholder="Nome completo"
                       oninput="atualizarParticipante(${index}, 'nome', this.value)">
                <input type="text" 
                       id="part_escritorio_${index}" 
                       placeholder="Escritório Regional"
                       oninput="atualizarParticipante(${index}, 'escritorio', this.value)">
                <button type="button" onclick="removerParticipante(${index})" style="background: #e53e3e; color: white; border: none; border-radius: 3px; width: 30px; height: 30px; cursor: pointer;">
                    ×
                </button>
            `;
            
            container.appendChild(div);
        }
        
        function atualizarParticipante(index, campo, valor) {
            if (!dadosFormulario.participantes[index]) {
                dadosFormulario.participantes[index] = { funcao: '', nome: '', escritorio: '' };
            }
            dadosFormulario.participantes[index][campo] = valor;
        }
        
        function removerParticipante(index) {
            const container = document.getElementById('participantesContainer');
            if (container.children[index]) {
                container.children[index].remove();
            }
            dadosFormulario.participantes.splice(index, 1);
            // Reindexar
            const items = container.children;
            for (let i = 0; i < items.length; i++) {
                const inputs = items[i].querySelectorAll('input');
                inputs[0].id = `part_funcao_${i}`;
                inputs[1].id = `part_nome_${i}`;
                inputs[2].id = `part_escritorio_${i}`;
                
                inputs[0].oninput = function() { atualizarParticipante(i, 'funcao', this.value); };
                inputs[1].oninput = function() { atualizarParticipante(i, 'nome', this.value); };
                inputs[2].oninput = function() { atualizarParticipante(i, 'escritorio', this.value); };
                
                items[i].querySelector('button').onclick = function() {
                    removerParticipante(i);
                };
            }
        }
        
        // Upload de imagens
        function adicionarImagens(event) {
            const files = event.target.files;
            const container = document.getElementById('imageGrid');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > 5 * 1024 * 1024) {
                    mostrarToast(`Imagem ${file.name} excede 5MB`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const index = dadosFormulario.imagens.length;
                    dadosFormulario.imagens.push({
                        data: e.target.result,
                        nome: file.name,
                        legenda: '',
                        municipio: ''
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'image-item';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-image" onclick="removerImagem(${index})">×</div>
                        <div class="image-info">
                            <input type="text" 
                                   placeholder="Legenda da imagem"
                                   oninput="atualizarImagem(${index}, 'legenda', this.value)">
                            <input type="text" 
                                   placeholder="Município - PR"
                                   oninput="atualizarImagem(${index}, 'municipio', this.value)">
                        </div>
                    `;
                    
                    container.appendChild(div);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function atualizarImagem(index, campo, valor) {
            if (dadosFormulario.imagens[index]) {
                dadosFormulario.imagens[index][campo] = valor;
            }
        }
        
        function removerImagem(index) {
            dadosFormulario.imagens.splice(index, 1);
            atualizarGridImagens();
        }
        
        function atualizarGridImagens() {
            const container = document.getElementById('imageGrid');
            container.innerHTML = '';
            
            dadosFormulario.imagens.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-item';
                div.innerHTML = `
                    <img src="${img.data}" alt="Preview">
                    <div class="remove-image" onclick="removerImagem(${index})">×</div>
                    <div class="image-info">
                        <input type="text" 
                               placeholder="Legenda da imagem"
                               value="${img.legenda || ''}"
                               oninput="atualizarImagem(${index}, 'legenda', this.value)">
                        <input type="text" 
                               placeholder="Município - PR"
                               value="${img.municipio || ''}"
                               oninput="atualizarImagem(${index}, 'municipio', this.value)">
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        // Salvar formulário
        function salvarFormulario() {
            // Coletar dados
            dadosFormulario.introducao = document.getElementById('introducao').value;
            dadosFormulario.data_vistoria = document.getElementById('data_vistoria').value;
            dadosFormulario.objetivo = document.getElementById('objetivo').value;
            dadosFormulario.metodologia = document.getElementById('metodologia').value;
            dadosFormulario.protocolo = document.getElementById('protocolo').value;
            dadosFormulario.tipo_licenciamento = document.getElementById('tipo_licenciamento').value;
            dadosFormulario.descricao_empreendimento = document.getElementById('descricao_empreendimento').value;
            dadosFormulario.titulo_fotos = document.getElementById('titulo_fotos').value;
            dadosFormulario.nome_lt = document.getElementById('nome_lt').value;
            dadosFormulario.tensao_lt = document.getElementById('tensao_lt').value;
            dadosFormulario.licenca_numero = document.getElementById('licenca_numero').value;
            dadosFormulario.conclusao = document.getElementById('conclusao').value;
            
            // Salvar no localStorage
            localStorage.setItem('formulario3', JSON.stringify(dadosFormulario));
            
            mostrarToast('Relatório salvo com sucesso!', 'success');
        }
        
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('formulario3');
            if (dadosSalvos) {
                dadosFormulario = JSON.parse(dadosSalvos);
                
                // Preencher campos
                document.getElementById('introducao').value = dadosFormulario.introducao || '';
                document.getElementById('data_vistoria').value = dadosFormulario.data_vistoria || '';
                document.getElementById('objetivo').value = dadosFormulario.objetivo || '';
                document.getElementById('metodologia').value = dadosFormulario.metodologia || '';
                document.getElementById('protocolo').value = dadosFormulario.protocolo || '';
                document.getElementById('tipo_licenciamento').value = dadosFormulario.tipo_licenciamento || '';
                document.getElementById('descricao_empreendimento').value = dadosFormulario.descricao_empreendimento || '';
                document.getElementById('titulo_fotos').value = dadosFormulario.titulo_fotos || '';
                document.getElementById('nome_lt').value = dadosFormulario.nome_lt || '';
                document.getElementById('tensao_lt').value = dadosFormulario.tensao_lt || '';
                document.getElementById('licenca_numero').value = dadosFormulario.licenca_numero || '';
                document.getElementById('conclusao').value = dadosFormulario.conclusao || '';
                
                // Carregar coordenadas
                if (dadosFormulario.coordenadas && dadosFormulario.coordenadas.length > 0) {
                    dadosFormulario.coordenadas.forEach((coord, index) => {
                        adicionarCoordenada();
                        document.getElementById(`coord_desc_${index}`).value = coord.descricao || '';
                        document.getElementById(`coord_e_${index}`).value = coord.este || '';
                        document.getElementById(`coord_s_${index}`).value = coord.sul || '';
                    });
                }
                
                // Carregar participantes
                if (dadosFormulario.participantes && dadosFormulario.participantes.length > 0) {
                    dadosFormulario.participantes.forEach((part, index) => {
                        adicionarParticipante();
                        document.getElementById(`part_funcao_${index}`).value = part.funcao || '';
                        document.getElementById(`part_nome_${index}`).value = part.nome || '';
                        document.getElementById(`part_escritorio_${index}`).value = part.escritorio || '';
                    });
                }
                
                // Carregar imagens
                if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                    atualizarGridImagens();
                }
                
                // Carregar assinatura
                if (dadosFormulario.assinatura) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = dadosFormulario.assinatura;
                }
                
                mostrarToast('Dados anteriores carregados', 'info');
            }
        }
        
        // Gerar PDF
        function gerarPDF() {
            salvarFormulario();
            
            if (!dadosFormulario.protocolo || !dadosFormulario.nome_lt || !dadosFormulario.tensao_lt) {
                mostrarToast('Preencha as informações básicas do empreendimento', 'error');
                return;
            }
            
            mostrarToast('Gerando PDF...', 'info');
            
            setTimeout(() => {
                const dataFormatada = new Date(dadosFormulario.data_vistoria).toLocaleDateString('pt-BR');
                const nomeArquivo = `Vistoria_Aerea_${dadosFormulario.nome_lt.replace(/\s+/g, '_')}_${dataFormatada.replace(/\//g, '-')}.pdf`;
                
                // Criar conteúdo do PDF
                let conteudo = `
                    ESCRITÓRIO REGIONAL DE CURITIBA
                    SETOR DE LICENCIAMENTO DE ENERGIA
                    RELATÓRIO DE VISTORIA AÉREA
                    
                    1. INTRODUÇÃO
                    ${dadosFormulario.introducao}
                    ${dadosFormulario.introducao_continuacao || ''}
                    
                    2. OBJETIVO
                    ${dadosFormulario.objetivo}
                    
                    3. METODOLOGIA
                    ${dadosFormulario.metodologia}
                    
                    Participantes da vistoria:
                `;
                
                // Adicionar participantes
                dadosFormulario.participantes.forEach(part => {
                    if (part.nome || part.funcao) {
                        conteudo += `
                    • ${part.funcao || ''} ${part.nome || ''} (${part.escritorio || ''})`;
                    }
                });
                
                conteudo += `
                    
                    4. LOCALIZAÇÃO E CONTEXTO DA VISTORIA
                    Protocolo: ${dadosFormulario.protocolo}
                    Tipo de licenciamento: ${dadosFormulario.tipo_licenciamento}
                    
                    ${dadosFormulario.descricao_empreendimento}
                    
                    Coordenadas geográficas UTM (SIRGAS 2000) 22J:
                `;
                
                // Adicionar coordenadas
                dadosFormulario.coordenadas.forEach(coord => {
                    if (coord.descricao || coord.este || coord.sul) {
                        conteudo += `
                    • ${coord.descricao || ''}: ${coord.este || ''}, ${coord.sul || ''}`;
                    }
                });
                
                conteudo += `
                    
                    5. REGISTROS FOTOGRÁFICOS
                    ${dadosFormulario.titulo_fotos}
                    
                    Total de imagens: ${dadosFormulario.imagens.length}
                `;
                
                // Adicionar imagens
                dadosFormulario.imagens.forEach(img => {
                    conteudo += `
                    • ${img.legenda || 'Sem legenda'} - ${img.municipio || ''}`;
                });
                
                conteudo += `
                    
                    6. CONCLUSÃO
                    ${dadosFormulario.nome_lt}, ${dadosFormulario.tensao_lt} kV
                    ${dadosFormulario.conclusao}
                    
                    
                    Assinatura: ${dadosFormulario.responsavel.nome}
                    ${dadosFormulario.responsavel.cargo}
                    ${dadosFormulario.responsavel.setor}
                `;
                
                // Criar e baixar arquivo
                const blob = new Blob([conteudo], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nomeArquivo;
                a.click();
                URL.revokeObjectURL(url);
                
                mostrarToast(`PDF "${nomeArquivo}" gerado com sucesso!`, 'success');
            }, 1000);
        }
        
        // Toast messages
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `<i class="fas fa-${icons[tipo]}"></i> ${mensagem}`;
            toast.style.background = {
                success: '#38a169',
                error: '#e53e3e',
                info: '#805ad5'
            }[tipo];
            
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
