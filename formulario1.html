<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulário 1 - Vistoria Técnica</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF para gerar PDFs reais -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            padding: 20px;
            font-size: 12pt;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            position: relative;
        }
        
        .header-form {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #2c7a47;
        }
        
        .header-form h1 {
            font-size: 16pt;
            color: #2c7a47;
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        
        .header-form h2 {
            font-size: 14pt;
            color: #444;
            margin-bottom: 5px;
        }
        
        .header-form h3 {
            font-size: 13pt;
            color: #666;
            font-weight: normal;
        }
        
        .info-group {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
            border-left: 4px solid #2c7a47;
        }
        
        .info-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }
        
        .info-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12pt;
        }
        
        .section {
            margin: 30px 0;
        }
        
        .section-title {
            background: #2c7a47;
            color: white;
            padding: 10px 15px;
            font-size: 13pt;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .condicionantes-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .condicionantes-table th {
            background: #f0f0f0;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: bold;
            color: #444;
        }
        
        .condicionantes-table td {
            padding: 12px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        
        .condicionantes-table tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .radio-group {
            display: flex;
            gap: 30px;
            margin-top: 5px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }
        
        .observacoes {
            margin-top: 15px;
        }
        
        .observacoes textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 100px;
            font-size: 12pt;
            resize: vertical;
        }
        
        .image-upload {
            margin: 20px 0;
            padding: 20px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
        }
        
        .image-upload:hover {
            border-color: #2c7a47;
            background: #f0fff4;
        }
        
        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-preview {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .image-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        
        .image-caption {
            padding: 8px;
            font-size: 10pt;
            background: #f5f5f5;
            text-align: center;
        }
        
        .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #e53e3e;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10pt;
        }
        
        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 12pt;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        .btn-primary {
            background: #2c7a47;
            color: white;
        }
        
        .btn-primary:hover {
            background: #22543d;
        }
        
        .btn-success {
            background: #38a169;
            color: white;
        }
        
        .btn-success:hover {
            background: #2c7a47;
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            background: #2c7a47;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .buttons, .image-upload, .toast { display: none; }
        }
        
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .radio-group { flex-direction: column; gap: 10px; }
            .buttons { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabeçalho do Formulário -->
        <div class="header-form">
            <h1>ESCRITÓRIO REGIONAL DE CURITIBA</h1>
            <h2>SETOR DE LICENCIAMENTO DE ENERGIA</h2>
            <h3>RELATÓRIO DE VISTORIA TÉCNICA</h3>
        </div>
        
        <!-- Informações do Empreendimento -->
        <div class="info-group">
            <label for="empreendimento">EMPREENDIMENTO:</label>
            <input type="text" id="empreendimento" placeholder="Nome do empreendimento" required>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
            <div class="info-group">
                <label for="protocolo">PROTOCOLO:</label>
                <input type="text" id="protocolo" placeholder="Número do protocolo" required>
            </div>
            <div class="info-group">
                <label for="data">DATA:</label>
                <input type="date" id="data" required>
            </div>
        </div>
        
        <!-- Seção 1: Atendimento às Condicionantes -->
        <div class="section">
            <div class="section-title">1. ATENDIMENTO ÀS CONDICIONANTES:</div>
            
            <table class="condicionantes-table">
                <thead>
                    <tr>
                        <th width="70%">CONDICIONANTES</th>
                        <th width="30%">ATENDE</th>
                    </tr>
                </thead>
                <tbody id="condicionantesBody">
                    <!-- Condicionantes serão adicionadas dinamicamente -->
                </tbody>
            </table>
            
            <button onclick="adicionarCondicionante()" style="margin-top: 10px; padding: 8px 15px; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer;">
                <i class="fas fa-plus"></i> Adicionar Condicionante
            </button>
        </div>
        
        <!-- Seção 2: Relatório de Conformidade -->
        <div class="section">
            <div class="section-title">2. RELATÓRIO DE CONFORMIDADE:</div>
            
            <table class="condicionantes-table">
                <thead>
                    <tr>
                        <th width="70%">CHECK-LIST IN-LOCO</th>
                        <th width="30%">ATENDE</th>
                    </tr>
                </thead>
                <tbody id="checklistBody">
                    <!-- Checklist será adicionado dinamicamente -->
                </tbody>
            </table>
        </div>
        
        <!-- Observações -->
        <div class="observacoes">
            <label for="observacoes">OBSERVAÇÕES ADICIONAIS:</label>
            <textarea id="observacoes" placeholder="Descreva observações relevantes da vistoria..."></textarea>
        </div>
        
        <!-- Upload de Imagens -->
        <div class="section">
            <div class="section-title">REGISTROS FOTOGRÁFICOS</div>
            
            <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                <i class="fas fa-camera fa-2x" style="color: #666; margin-bottom: 10px;"></i>
                <p>Clique para adicionar fotos da vistoria</p>
                <p style="font-size: 10pt; color: #888;">Máx. 5MB por imagem (JPG, PNG)</p>
            </div>
            <input type="file" id="imageInput" accept="image/*" multiple style="display: none;" onchange="previewImages(event)">
            
            <div class="image-preview-container" id="imagePreviewContainer"></div>
        </div>
        
        <!-- Assinatura -->
        <div class="info-group">
            <label for="assinatura">ASSINATURA DO RESPONSÁVEL TÉCNICO:</label>
            <div style="margin-top: 10px; padding: 15px; border: 1px solid #ddd; border-radius: 4px; min-height: 100px; background: #fafafa;">
                <canvas id="assinaturaCanvas" width="800" height="150" style="border: 1px dashed #ccc; background: white; cursor: crosshair;"></canvas>
                <div style="margin-top: 10px; display: flex; gap: 10px;">
                    <button type="button" onclick="limparAssinatura()" style="padding: 8px 15px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-eraser"></i> Limpar
                    </button>
                    <button type="button" onclick="salvarAssinatura()" style="padding: 8px 15px; background: #2c7a47; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        <i class="fas fa-save"></i> Salvar Assinatura
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Botões de Ação -->
        <div class="buttons">
            <button class="btn btn-secondary" onclick="window.location.href = 'index.html'">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="btn btn-primary" onclick="salvarFormulario()">
                <i class="fas fa-save"></i> Salvar Rascunho
            </button>
            <button class="btn btn-success" onclick="gerarPDFReal()">
                <i class="fas fa-file-pdf"></i> Gerar PDF
            </button>
        </div>
    </div>
    
    <!-- Toast Notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // Dados do formulário
        let dadosFormulario = {
            empreendimento: '',
            protocolo: '',
            data: '',
            condicionantes: [],
            checklist: [],
            observacoes: '',
            imagens: [],
            assinatura: null
        };
        
        // Configurar canvas de assinatura
        const canvas = document.getElementById('assinaturaCanvas');
        const ctx = canvas.getContext('2d');
        let desenhando = false;
        
        // Condicionantes padrão
        const condicionantesPadrao = [
            "O esgoto sanitário deverá ser encaminhado para a fossa séptica e sumidouro ou para rede coletora pública.",
            "Disposição e destinação adequadas dos resíduos sólidos e líquidos.",
            "",
            "",
            "",
            "",
            ""
        ];
        
        // Checklist padrão
        const checklistPadrao = [
            "Alvará de funcionamento",
            "Licença de Operação vigente",
            "Plano de Atendimento a Emergências",
            "FISPQ's - ficha de informação de segurança de produtos químicos",
            "Iluminação antifaísca em funcionamento",
            "Sinalização de advertência de obrigatoriedade ao uso de EPI's",
            "Sinalização de alerta de perigo e restrição de entrada a pessoas autorizadas",
            "Sinalização de segurança para manobra de veículos",
            "Validade dos extintores",
            "Mapa de risco",
            "Indício de vazamento de óleo sob os transformadores",
            "Existência de filme de óleo no sistema SAO*",
            "Avarias nas tampas do SAO* (infiltração de água pluvial pelas tampas)",
            "Necessidade de limpeza das canaletas",
            "Indícios de contaminação do solo",
            "Bacia de Contenção",
            "Existência de indícios de processos erosivos",
            "Necessidade limpeza (existência de lixo/materiais de manutenção a recolher)",
            "Necessidade de manutenção da vegetação"
        ];
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Data atual
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('data').value = hoje;
            
            // Configurar canvas
            ctx.strokeStyle = '#2c7a47';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            
            // Eventos do canvas
            canvas.addEventListener('mousedown', iniciarDesenho);
            canvas.addEventListener('mousemove', desenhar);
            canvas.addEventListener('mouseup', pararDesenho);
            
            // Carregar dados salvos
            carregarDados();
            
            // Gerar condicionantes
            gerarCondicionantes();
            
            // Gerar checklist
            gerarChecklist();
        });
        
        // Funções de assinatura
        function iniciarDesenho(e) {
            desenhando = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        }
        
        function desenhar(e) {
            if (!desenhando) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        }
        
        function pararDesenho() {
            desenhando = false;
        }
        
        function limparAssinatura() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            dadosFormulario.assinatura = null;
        }
        
        function salvarAssinatura() {
            dadosFormulario.assinatura = canvas.toDataURL();
            mostrarToast('Assinatura salva com sucesso!', 'success');
        }
        
        // Gerar condicionantes
        function gerarCondicionantes() {
            const tbody = document.getElementById('condicionantesBody');
            let html = '';
            
            condicionantesPadrao.forEach((cond, index) => {
                html += `
                    <tr>
                        <td>
                            <input type="text" 
                                   id="cond_${index}" 
                                   value="${cond}" 
                                   oninput="atualizarCondicionante(${index}, this.value)"
                                   style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                        </td>
                        <td>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="cond_atende_${index}" value="SIM" onchange="atualizarRespostaCond(${index}, 'SIM')">
                                    SIM
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="cond_atende_${index}" value="NÃO" onchange="atualizarRespostaCond(${index}, 'NÃO')">
                                    NÃO
                                </label>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        function adicionarCondicionante() {
            const tbody = document.getElementById('condicionantesBody');
            const index = tbody.children.length;
            
            const novaLinha = document.createElement('tr');
            novaLinha.innerHTML = `
                <td>
                    <input type="text" 
                           id="cond_${index}" 
                           placeholder="Descreva a condicionante..."
                           oninput="atualizarCondicionante(${index}, this.value)"
                           style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 3px;">
                </td>
                <td>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="cond_atende_${index}" value="SIM" onchange="atualizarRespostaCond(${index}, 'SIM')">
                            SIM
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="cond_atende_${index}" value="NÃO" onchange="atualizarRespostaCond(${index}, 'NÃO')">
                            NÃO
                        </label>
                    </div>
                </td>
            `;
            
            tbody.appendChild(novaLinha);
        }
        
        // Gerar checklist
        function gerarChecklist() {
            const tbody = document.getElementById('checklistBody');
            let html = '';
            
            checklistPadrao.forEach((item, index) => {
                html += `
                    <tr>
                        <td>${item}</td>
                        <td>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="check_${index}" value="SIM" onchange="atualizarRespostaCheck(${index}, 'SIM')">
                                    SIM
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="check_${index}" value="NÃO" onchange="atualizarRespostaCheck(${index}, 'NÃO')">
                                    NÃO
                                </label>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Atualizar dados
        function atualizarCondicionante(index, texto) {
            if (!dadosFormulario.condicionantes[index]) {
                dadosFormulario.condicionantes[index] = { texto: '', resposta: '' };
            }
            dadosFormulario.condicionantes[index].texto = texto;
        }
        
        function atualizarRespostaCond(index, resposta) {
            if (!dadosFormulario.condicionantes[index]) {
                dadosFormulario.condicionantes[index] = { texto: '', resposta: '' };
            }
            dadosFormulario.condicionantes[index].resposta = resposta;
        }
        
        function atualizarRespostaCheck(index, resposta) {
            if (!dadosFormulario.checklist[index]) {
                dadosFormulario.checklist[index] = { texto: checklistPadrao[index], resposta: '' };
            }
            dadosFormulario.checklist[index].resposta = resposta;
        }
        
        // Upload de imagens
        function previewImages(event) {
            const files = event.target.files;
            const container = document.getElementById('imagePreviewContainer');
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.size > 5 * 1024 * 1024) {
                    mostrarToast(`Imagem ${file.name} excede 5MB`, 'error');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const index = dadosFormulario.imagens.length;
                    dadosFormulario.imagens.push({
                        data: e.target.result,
                        nome: file.name,
                        legenda: ''
                    });
                    
                    const div = document.createElement('div');
                    div.className = 'image-preview';
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="remove-image" onclick="removerImagem(${index})">×</div>
                        <input type="text" 
                               class="image-caption" 
                               placeholder="Legenda da imagem..."
                               oninput="atualizarLegenda(${index}, this.value)"
                               style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                    `;
                    
                    container.appendChild(div);
                };
                
                reader.readAsDataURL(file);
            }
        }
        
        function atualizarLegenda(index, legenda) {
            if (dadosFormulario.imagens[index]) {
                dadosFormulario.imagens[index].legenda = legenda;
            }
        }
        
        function removerImagem(index) {
            dadosFormulario.imagens.splice(index, 1);
            atualizarPreviewImagens();
        }
        
        function atualizarPreviewImagens() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';
            
            dadosFormulario.imagens.forEach((img, index) => {
                const div = document.createElement('div');
                div.className = 'image-preview';
                div.innerHTML = `
                    <img src="${img.data}" alt="Preview">
                    <div class="remove-image" onclick="removerImagem(${index})">×</div>
                    <input type="text" 
                           class="image-caption" 
                           placeholder="Legenda da imagem..."
                           value="${img.legenda || ''}"
                           oninput="atualizarLegenda(${index}, this.value)"
                           style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
                `;
                container.appendChild(div);
            });
        }
        
        // Salvar formulário
        function salvarFormulario() {
            // Coletar dados básicos
            dadosFormulario.empreendimento = document.getElementById('empreendimento').value;
            dadosFormulario.protocolo = document.getElementById('protocolo').value;
            dadosFormulario.data = document.getElementById('data').value;
            dadosFormulario.observacoes = document.getElementById('observacoes').value;
            
            // Coletar condicionantes
            condicionantesPadrao.forEach((_, index) => {
                const input = document.getElementById(`cond_${index}`);
                if (input) {
                    if (!dadosFormulario.condicionantes[index]) {
                        dadosFormulario.condicionantes[index] = { texto: '', resposta: '' };
                    }
                    dadosFormulario.condicionantes[index].texto = input.value;
                    
                    const radio = document.querySelector(`input[name="cond_atende_${index}"]:checked`);
                    if (radio) {
                        dadosFormulario.condicionantes[index].resposta = radio.value;
                    }
                }
            });
            
            // Coletar checklist
            checklistPadrao.forEach((_, index) => {
                const radio = document.querySelector(`input[name="check_${index}"]:checked`);
                if (radio) {
                    if (!dadosFormulario.checklist[index]) {
                        dadosFormulario.checklist[index] = { texto: checklistPadrao[index], resposta: '' };
                    }
                    dadosFormulario.checklist[index].resposta = radio.value;
                }
            });
            
            // Salvar no localStorage
            localStorage.setItem('formulario1', JSON.stringify(dadosFormulario));
            
            mostrarToast('Formulário salvo com sucesso!', 'success');
        }
        
        function carregarDados() {
            const dadosSalvos = localStorage.getItem('formulario1');
            if (dadosSalvos) {
                dadosFormulario = JSON.parse(dadosSalvos);
                
                // Preencher campos básicos
                document.getElementById('empreendimento').value = dadosFormulario.empreendimento || '';
                document.getElementById('protocolo').value = dadosFormulario.protocolo || '';
                document.getElementById('data').value = dadosFormulario.data || '';
                document.getElementById('observacoes').value = dadosFormulario.observacoes || '';
                
                // Preencher condicionantes
                dadosFormulario.condicionantes.forEach((cond, index) => {
                    const input = document.getElementById(`cond_${index}`);
                    if (input) input.value = cond.texto || '';
                    
                    if (cond.resposta) {
                        const radio = document.querySelector(`input[name="cond_atende_${index}"][value="${cond.resposta}"]`);
                        if (radio) radio.checked = true;
                    }
                });
                
                // Preencher checklist
                dadosFormulario.checklist.forEach((item, index) => {
                    if (item.resposta) {
                        const radio = document.querySelector(`input[name="check_${index}"][value="${item.resposta}"]`);
                        if (radio) radio.checked = true;
                    }
                });
                
                // Carregar imagens
                if (dadosFormulario.imagens && dadosFormulario.imagens.length > 0) {
                    atualizarPreviewImagens();
                }
                
                // Carregar assinatura
                if (dadosFormulario.assinatura) {
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    };
                    img.src = dadosFormulario.assinatura;
                }
                
                mostrarToast('Dados anteriores carregados', 'info');
            }
        }
        
        // ============================================
        // FUNÇÃO PRINCIPAL PARA GERAR PDF REAL
        // ============================================
        function gerarPDFReal() {
            salvarFormulario();
            
            if (!dadosFormulario.empreendimento || !dadosFormulario.protocolo || !dadosFormulario.data) {
                mostrarToast('Preencha as informações básicas do empreendimento', 'error');
                return;
            }
            
            mostrarToast('Gerando PDF profissional...', 'info');
            
            // Usar jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurações da página
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const marginLeft = 20;
            const marginRight = 20;
            const marginTop = 30;
            let yPos = marginTop;
            
            // ============================================
            // CABEÇALHO
            // ============================================
            doc.setFontSize(16);
            doc.setFont('helvetica', 'bold');
            doc.text("ESCRITÓRIO REGIONAL DE CURITIBA", pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(14);
            doc.text("SETOR DE LICENCIAMENTO DE ENERGIA", pageWidth / 2, yPos, { align: 'center' });
            yPos += 8;
            
            doc.setFontSize(12);
            doc.text("RELATÓRIO DE VISTORIA TÉCNICA", pageWidth / 2, yPos, { align: 'center' });
            yPos += 15;
            
            // Linha separadora
            doc.setLineWidth(0.5);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 10;
            
            // ============================================
            // INFORMAÇÕES DO EMPREENDIMENTO
            // ============================================
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text("EMPREENDIMENTO:", marginLeft, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(dadosFormulario.empreendimento, marginLeft + 45, yPos);
            yPos += 7;
            
            doc.setFont('helvetica', 'bold');
            doc.text("PROTOCOLO:", marginLeft, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(dadosFormulario.protocolo, marginLeft + 30, yPos);
            
            doc.setFont('helvetica', 'bold');
            doc.text("DATA:", pageWidth - 60, yPos);
            doc.setFont('helvetica', 'normal');
            doc.text(dadosFormulario.data, pageWidth - 40, yPos);
            yPos += 10;
            
            // ============================================
            // 1. ATENDIMENTO ÀS CONDICIONANTES
            // ============================================
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = marginTop;
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text("1. ATENDIMENTO ÀS CONDICIONANTES:", marginLeft, yPos);
            yPos += 10;
            
            // Tabela de condicionantes
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("CONDICIONANTES", marginLeft, yPos);
            doc.text("ATENDE", pageWidth - 40, yPos, { align: 'right' });
            yPos += 5;
            
            // Linha da tabela
            doc.setLineWidth(0.2);
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 5;
            
            // Itens das condicionantes
            doc.setFont('helvetica', 'normal');
            dadosFormulario.condicionantes.forEach(cond => {
                if (cond.texto && cond.texto.trim()) {
                    // Verificar se precisa de nova página
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = marginTop;
                    }
                    
                    // Texto da condicionante (com quebra de linha)
                    const lines = doc.splitTextToSize(cond.texto, pageWidth - marginLeft - marginRight - 30);
                    lines.forEach(line => {
                        doc.text(line, marginLeft + 2, yPos);
                        yPos += 5;
                    });
                    
                    // Resposta
                    doc.text(cond.resposta || "-", pageWidth - 40, yPos - (lines.length * 5), { align: 'right' });
                    
                    // Espaço entre itens
                    yPos += 3;
                }
            });
            
            yPos += 10;
            
            // ============================================
            // 2. RELATÓRIO DE CONFORMIDADE
            // ============================================
            if (yPos > pageHeight - 50) {
                doc.addPage();
                yPos = marginTop;
            }
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text("2. RELATÓRIO DE CONFORMIDADE:", marginLeft, yPos);
            yPos += 10;
            
            // Tabela de checklist
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text("CHECK-LIST IN-LOCO", marginLeft, yPos);
            doc.text("ATENDE", pageWidth - 40, yPos, { align: 'right' });
            yPos += 5;
            
            // Linha da tabela
            doc.line(marginLeft, yPos, pageWidth - marginRight, yPos);
            yPos += 5;
            
            // Itens do checklist
            doc.setFont('helvetica', 'normal');
            dadosFormulario.checklist.forEach(item => {
                if (item.texto) {
                    // Verificar se precisa de nova página
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = marginTop;
                    }
                    
                    const lines = doc.splitTextToSize(item.texto, pageWidth - marginLeft - marginRight - 30);
                    lines.forEach(line => {
                        doc.text(line, marginLeft + 2, yPos);
                        yPos += 5;
                    });
                    
                    doc.text(item.resposta || "-", pageWidth - 40, yPos - (lines.length * 5), { align: 'right' });
                    yPos += 3;
                }
            });
            
            yPos += 10;
            
            // ============================================
            // OBSERVAÇÕES
            // ============================================
            if (dadosFormulario.observacoes && dadosFormulario.observacoes.trim()) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = marginTop;
                }
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("OBSERVAÇÕES ADICIONAIS:", marginLeft, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                const obsLines = doc.splitTextToSize(dadosFormulario.observacoes, pageWidth - marginLeft - marginRight);
                obsLines.forEach(line => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = marginTop;
                    }
                    doc.text(line, marginLeft, yPos);
                    yPos += 5;
                });
                
                yPos += 10;
            }
            
            // ============================================
            // REGISTROS FOTOGRÁFICOS
            // ============================================
            if (dadosFormulario.imagens.length > 0) {
                if (yPos > pageHeight - 50) {
                    doc.addPage();
                    yPos = marginTop;
                }
                
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text("REGISTROS FOTOGRÁFICOS:", marginLeft, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Total de imagens: ${dadosFormulario.imagens.length}`, marginLeft, yPos);
                yPos += 7;
                
                dadosFormulario.imagens.forEach((img, index) => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = marginTop;
                    }
                    
                    doc.text(`${index + 1}. ${img.legenda || 'Imagem sem legenda'}`, marginLeft, yPos);
                    yPos += 5;
                });
            }
            
            // ============================================
            // RODAPÉ
            // ============================================
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                
                // Número da página
                doc.setFontSize(8);
                doc.text(`Página ${i} de ${totalPages}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
                
                // Data de geração
                const dataGeracao = new Date().toLocaleDateString('pt-BR');
                doc.text(`Gerado em: ${dataGeracao}`, pageWidth - marginRight, pageHeight - 10, { align: 'right' });
                
                // Logo IAT (se tiver)
                doc.setFontSize(6);
                doc.text("IAT - Instituto Água e Terra - Paraná", marginLeft, pageHeight - 10);
            }
            
            // ============================================
            // SALVAR PDF
            // ============================================
            const nomeArquivo = `Vistoria_Tecnica_${dadosFormulario.empreendimento.replace(/\s+/g, '_')}_${dadosFormulario.data.replace(/\//g, '-')}.pdf`;
            doc.save(nomeArquivo);
            
            mostrarToast(`PDF "${nomeArquivo}" gerado com sucesso!`, 'success');
        }
        
        // Toast messages
        function mostrarToast(mensagem, tipo = 'success') {
            const toast = document.getElementById('toast');
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                info: 'info-circle'
            };
            
            toast.innerHTML = `<i class="fas fa-${icons[tipo]}"></i> ${mensagem}`;
            toast.style.background = {
                success: '#2c7a47',
                error: '#e53e3e',
                info: '#3182ce'
            }[tipo];
            
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>
